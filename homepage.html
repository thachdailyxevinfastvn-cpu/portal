<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ - Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Nạp file cấu hình -->
    <script src="config.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f5f5;
        }
        /* Hiệu ứng gõ chữ */
        #typing-slogan::after {
            content: '|';
            animation: blink 0.7s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        /* CSS cho Carousel được tích hợp vào đây */
        .carousel-section {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 80px; 
            padding-bottom: 60px;
            overflow: hidden;
        }

        .about-title {
            font-size: 6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            white-space: nowrap;
            font-family: "Arial Black", "Arial Bold", Arial, sans-serif;
            background: linear-gradient(to bottom, rgb(8 42 123 / 25%) 30%, rgb(255 255 255 / 0%) 76%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            z-index: 0;
        }

        .carousel-container {
            width: 100%;
            max-width: 1200px;
            height: 450px;
            position: relative;
            perspective: 1000px;
        }

        .carousel-track {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .card {
            position: absolute;
            width: 280px;
            height: 380px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transition: transform 1s cubic-bezier(0.65, 0, 0.35, 1),
                        opacity 0.8s cubic-bezier(0.65, 0, 0.35, 1),
                        filter 0.8s cubic-bezier(0.65, 0, 0.35, 1);
            cursor: pointer;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* SỬA LỖI: Áp dụng khoảng cách của mobile cho desktop */
        .card.center { z-index: 10; transform: scale(1.1) translateZ(0); filter: none; }
        .card.left-2 { z-index: 1; transform: translateX(-250px) scale(0.8) translateZ(-300px); opacity: 0.7; filter: grayscale(100%) blur(2px); }
        .card.left-1 { z-index: 5; transform: translateX(-120px) scale(0.9) translateZ(-100px); opacity: 0.9; filter: grayscale(80%) blur(1px); }
        .card.right-1 { z-index: 5; transform: translateX(120px) scale(0.9) translateZ(-100px); opacity: 0.9; filter: grayscale(80%) blur(1px); }
        .card.right-2 { z-index: 1; transform: translateX(250px) scale(0.8) translateZ(-300px); opacity: 0.7; filter: grayscale(100%) blur(2px); }
        .card.hidden { opacity: 0; pointer-events: none; }

        .member-info { text-align: center; margin-top: 20px; transition: all 0.5s ease-out; }
        .member-name { color: rgb(8, 42, 123); font-size: 2.5rem; font-weight: 700; margin-bottom: 5px; position: relative; display: inline-block; }
        .member-role { color: #848696; font-size: 1.2rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; }
        .member-name::before, .member-name::after { content: ""; position: absolute; top: 100%; width: 100px; height: 2px; background: rgb(8, 42, 123); }
        .member-name::before { left: -120px; }
        .member-name::after { right: -120px; }

        .dots { display: flex; justify-content: center; gap: 10px; margin-top: 30px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(8, 42, 123, 0.2); cursor: pointer; transition: all 0.3s ease; }
        .dot.active { background: rgb(8, 42, 123); transform: scale(1.2); }

        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(8, 42, 123, 0.6); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; transition: all 0.3s ease; font-size: 1.5rem; border: none; outline: none; padding-bottom: 4px; }
        .nav-arrow:hover { background: rgba(0, 0, 0, 0.8); transform: translateY(-50%) scale(1.1); }
        .nav-arrow.left { left: 20px; padding-right: 3px; }
        .nav-arrow.right { right: 20px; padding-left: 3px; }

        @media (max-width: 768px) {
            .about-title { font-size: 4.5rem; }
            .card { width: 200px; height: 280px; }
            /* Giữ nguyên các giá trị này cho mobile */
            .card.left-2 { transform: translateX(-250px) scale(0.8) translateZ(-300px); }
            .card.left-1 { transform: translateX(-120px) scale(0.9) translateZ(-100px); }
            .card.right-1 { transform: translateX(120px) scale(0.9) translateZ(-100px); }
            .card.right-2 { transform: translateX(250px) scale(0.8) translateZ(-300px); }
            .member-name { font-size: 2rem; }
            .member-name::before, .member-name::after { width: 50px; }
            .member-name::before { left: -70px; }
            .member-name::after { right: -70px; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header và Menu -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-blue-600">Portal</a>
            <div class="hidden md:flex items-center space-x-4">
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Trang chủ</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Kho xe</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Xe đã bán</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Chính sách</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Ngân hàng</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">KPI</a>
                <a href="#" class="px-3 py-2 text-gray-700 font-medium rounded hover:bg-gray-100">Tạo văn bản</a>
            </div>
            <div class="flex items-center">
                <div id="user-profile" class="flex items-center space-x-3">
                     <span id="user-fullname" class="text-gray-800 font-semibold hidden md:block"></span>
                     <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500">
                </div>
                <button id="logout-btn" class="ml-4 text-gray-500 hover:text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
                <button id="mobile-menu-button" class="md:hidden ml-4 text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t">
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Trang chủ</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Kho xe</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Xe đã bán</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Chính sách</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ngân hàng</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">KPI</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tạo văn bản</a>
        </div>
    </header>

    <!-- Nội dung chính -->
    <main class="container mx-auto px-6 py-8">
        <!-- Lời chào -->
        <section class="text-center">
            <h1 id="welcome-message" class="text-4xl md:text-5xl font-extrabold text-gray-800"></h1>
            <p id="typing-slogan" class="mt-4 text-lg text-gray-600 h-6"></p>
        </section>

        <!-- Our Team - Giao diện Carousel -->
        <section id="our-team-section" class="carousel-section">
            <div id="team-loader" class="text-center p-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-500">Đang tải danh sách team...</p>
            </div>
            <!-- Nội dung carousel sẽ được tạo bằng JS -->
        </section>
    </main>

    <script>
        // --- DOM Elements ---
        const userFullNameDisplay = document.getElementById('user-fullname');
        const userAvatarDisplay = document.getElementById('user-avatar');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const teamSection = document.getElementById('our-team-section');
        const teamLoader = document.getElementById('team-loader');
        const typingSlogan = document.getElementById('typing-slogan');

        let teamData = []; // Mảng để lưu dữ liệu team từ API

        // --- Hàm gọi API (JSONP) ---
        async function handleApiRequest(payload) {
            if (typeof APPS_SCRIPT_URL === 'undefined' || !APPS_SCRIPT_URL) {
                console.error('Lỗi: Không tìm thấy URL của Apps Script trong file config.js.');
                return null;
            }
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                const script = document.createElement('script');
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                const params = new URLSearchParams({ ...payload, callback: callbackName });
                script.src = `${APPS_SCRIPT_URL}?${params.toString()}`;
                document.body.appendChild(script);
            });
        }
        
        // --- Hàm hiệu ứng gõ chữ ---
        function startTypingEffect() {
            const text = "Bán xe ầm ầm tiền về ào ào nhé!";
            let i = 0;
            let isDeleting = false;

            function type() {
                if (isDeleting) {
                    if (i > 0) {
                        typingSlogan.textContent = text.substring(0, i - 1);
                        i--;
                        setTimeout(type, 50);
                    } else {
                        isDeleting = false;
                        setTimeout(type, 500);
                    }
                } else {
                    if (i < text.length) {
                        typingSlogan.textContent = text.substring(0, i + 1);
                        i++;
                        setTimeout(type, 100);
                    } else {
                        isDeleting = true;
                        setTimeout(type, 3000);
                    }
                }
            }
            type();
        }

        // --- Hàm tạo và hiển thị Carousel ---
        function buildAndInitCarousel() {
            teamLoader.remove();

            teamSection.innerHTML = `
                <h1 class="about-title">OUR TEAM</h1>
                <div class="carousel-container">
                    <button class="nav-arrow left">‹</button>
                    <div class="carousel-track"></div>
                    <button class="nav-arrow right">›</button>
                </div>
                <div class="member-info">
                    <h2 class="member-name"></h2>
                    <p class="member-role"></p>
                </div>
                <div class="dots"></div>
            `;

            const carouselTrack = teamSection.querySelector('.carousel-track');
            const dotsContainer = teamSection.querySelector('.dots');

            teamData.forEach((member, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.innerHTML = `<img src="${member.imageUrl || 'https://placehold.co/280x380/EBF4FF/76A9FA?text=User'}" alt="${member.fullName}" onerror="this.onerror=null;this.src='https://placehold.co/280x380/EBF4FF/76A9FA?text=Error';">`;
                carouselTrack.appendChild(card);

                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.dataset.index = index;
                dotsContainer.appendChild(dot);
            });

            initCarouselLogic();
        }

        function initCarouselLogic() {
            const cards = document.querySelectorAll(".card");
            const dots = document.querySelectorAll(".dot");
            const memberName = document.querySelector(".member-name");
            const memberRole = document.querySelector(".member-role");
            const leftArrow = document.querySelector(".nav-arrow.left");
            const rightArrow = document.querySelector(".nav-arrow.right");
            let currentIndex = 0;
            let isAnimating = false;

            function updateCarousel(newIndex) {
                if (isAnimating || cards.length === 0) return;
                isAnimating = true;

                currentIndex = (newIndex + cards.length) % cards.length;

                cards.forEach((card, i) => {
                    const offset = (i - currentIndex + cards.length) % cards.length;
                    card.className = 'card';
                    
                    if (offset === 0) card.classList.add("center");
                    else if (offset === 1) card.classList.add("right-1");
                    else if (offset === 2) card.classList.add("right-2");
                    else if (offset === cards.length - 1) card.classList.add("left-1");
                    else if (offset === cards.length - 2) card.classList.add("left-2");
                    else card.classList.add("hidden");
                });

                dots.forEach((dot, i) => dot.classList.toggle("active", i === currentIndex));

                memberName.style.opacity = "0";
                memberRole.style.opacity = "0";

                setTimeout(() => {
                    memberName.textContent = teamData[currentIndex].fullName;
                    memberRole.textContent = teamData[currentIndex].role || 'Thành viên';
                    memberName.style.opacity = "1";
                    memberRole.style.opacity = "1";
                }, 300);

                setTimeout(() => { isAnimating = false; }, 1000);
            }

            leftArrow.addEventListener("click", () => updateCarousel(currentIndex - 1));
            rightArrow.addEventListener("click", () => updateCarousel(currentIndex + 1));
            dots.forEach((dot, i) => dot.addEventListener("click", () => updateCarousel(i)));
            cards.forEach((card, i) => card.addEventListener("click", () => updateCarousel(i)));
            
            document.addEventListener("keydown", (e) => {
                if (e.key === "ArrowLeft") updateCarousel(currentIndex - 1);
                else if (e.key === "ArrowRight") updateCarousel(currentIndex + 1);
            });

            let touchStartX = 0;
            document.addEventListener("touchstart", (e) => { touchStartX = e.changedTouches[0].screenX; });
            document.addEventListener("touchend", (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) updateCarousel(currentIndex + 1);
                    else updateCarousel(currentIndex - 1);
                }
            });

            // Khởi tạo carousel ở vị trí đầu tiên (người dùng đăng nhập)
            updateCarousel(0);
        }

        // --- Hàm xử lý khi tải trang ---
        window.addEventListener('load', async () => {
            const userDataString = sessionStorage.getItem('loggedInUser');
            if (!userDataString) {
                window.location.href = 'index.html';
                return;
            }

            const userData = JSON.parse(userDataString);
            
            userFullNameDisplay.textContent = userData.fullName;
            userAvatarDisplay.src = userData.imageUrl || 'https://placehold.co/40x40/EBF4FF/76A9FA?text=:)';
            welcomeMessage.textContent = `Chào mừng trở lại, ${userData.fullName}!`;

            startTypingEffect();

            const result = await handleApiRequest({ action: 'getAllUsers' });
            if (result && result.success) {
                let users = result.users;
                
                // Tìm và đưa người dùng đăng nhập lên đầu danh sách
                const loggedInUserIndex = users.findIndex(user => user.fullName === userData.fullName);
                if (loggedInUserIndex > -1) {
                    const loggedInUser = users.splice(loggedInUserIndex, 1)[0];
                    users.unshift(loggedInUser);
                }
                teamData = users.map(user => ({
                    fullName: user.fullName,
                    imageUrl: user.imageUrl,
                    role: user.role
                }));
                buildAndInitCarousel();
            } else {
                teamLoader.innerHTML = '<p class="text-red-500">Không thể tải danh sách team.</p>';
            }
        });
        
        // --- Xử lý đăng xuất ---
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'index.html';
        });

        // --- Xử lý menu mobile ---
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

    </script>
</body>
</html>
