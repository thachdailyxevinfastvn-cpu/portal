<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω kho xe</title>
  <style>
    body { font-family: sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 4px 8px; text-align: left; }
    button { margin-right: 8px; padding: 4px 12px; }
    #log { background: #f7f7f7; padding: 8px; border: 1px solid #ccc; margin-top: 16px; font-size: 14px; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>üöó Qu·∫£n l√Ω kho xe</h1>
  <div id="tabs"></div>
  <div id="table-container"></div>
  <div id="log"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbynYKon7UHmfwL_qRvjVu8c5OuzcoqWGkq0n2ticP7BGPDpI5DC5DH_KgLhqbPXuREO/exec";
    const sheetNames = ["CHU·∫®N B·ªä V·ªÄ", "KHO XE B√ÅN", "H√ÄNG CH·ªú GH√âP XE", "GH√âP XE", "XHƒê", "ƒê√É GIAO XE"];
    let allData = {};
    let activeSheet = "";

    function logPhase(msg) {
      const logDiv = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${msg}<br>`;
    }

    async function fetchData(sheetName) {
      try {
        logPhase(`üì§ G·ª≠i y√™u c·∫ßu l·∫•y d·ªØ li·ªáu cho sheet: ${sheetName}`);
        const res = await fetch(`${API_URL}?action=getSheetData&sheetName=${encodeURIComponent(sheetName)}`);
        logPhase(`‚úÖ ƒê√£ nh·∫≠n ph·∫£n h·ªìi t·ª´ server (${res.status})`);

        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const json = await res.json();
        logPhase(`üì¶ D·ªØ li·ªáu tr·∫£ v·ªÅ: ${JSON.stringify(json).substring(0, 100)}...`);

        if (json.error) {
          logPhase(`‚ùå L·ªói t·ª´ server: ${json.message}`);
          return;
        }

        allData[sheetName] = json;
        if (!activeSheet) {
          activeSheet = sheetName;
          renderTable(sheetName);
        }
        logPhase(`‚úÖ ƒê√£ x·ª≠ l√Ω xong sheet: ${sheetName}`);
      } catch (err) {
        logPhase(`‚ùå L·ªói khi x·ª≠ l√Ω sheet "${sheetName}": ${err.message}`);
        console.error(err);
      }
    }

    function renderTabs() {
      const tabsDiv = document.getElementById("tabs");
      sheetNames.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = () => {
          activeSheet = name;
          renderTable(name);
        };
        tabsDiv.appendChild(btn);
      });
    }

    function renderTable(sheetName) {
      logPhase(`üìã B·∫Øt ƒë·∫ßu d·ª±ng b·∫£ng cho sheet: ${sheetName}`);
      const container = document.getElementById("table-container");
      container.innerHTML = "";

      const dataObj = allData[sheetName];
      if (!dataObj || !dataObj.headers || !dataObj.data) {
        container.innerHTML = `<p style="color:red;">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá cho tab: ${sheetName}</p>`;
        logPhase(`‚ùå Sheet "${sheetName}" kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.`);
        return;
      }

      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      Object.values(dataObj.headers).forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      dataObj.data.forEach(row => {
        const tr = document.createElement("tr");
        Object.keys(dataObj.headers).forEach(key => {
          const td = document.createElement("td");
          td.textContent = row[key] || "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
      logPhase(`‚úÖ ƒê√£ hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu: ${sheetName}`);
    }

    async function init() {
      logPhase("üöÄ B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o ·ª©ng d·ª•ng...");
      renderTabs();
      for (const name of sheetNames) {
        await fetchData(name);
      }
      logPhase("üéâ Ho√†n t·∫•t n·∫°p t·∫•t c·∫£ d·ªØ li·ªáu.");
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
