<script>
    // ... (toàn bộ code JS khác của bạn giữ nguyên) ...

    // --- DATA HANDLING (PHIÊN BẢN JSONP) ---
    function fetchData() {
        console.log('Bắt đầu quá trình tải dữ liệu bằng JSONP...');
        loadingState.classList.remove('hidden');
        contentWrapper.classList.add('hidden');

        // 1. Tên hàm callback sẽ được định nghĩa trên toàn cục (window)
        const callbackName = 'handleKhoXeResponse';

        // 2. Định nghĩa hàm callback để xử lý dữ liệu khi nó được trả về
        window[callbackName] = function(response) {
            console.log('Đã nhận dữ liệu từ JSONP:', response);

            try {
                if (response && response.success) {
                    allData = response.data;
                    initializeApp();
                } else {
                    const errorMessage = response.message || 'Lỗi không xác định từ server.';
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Lỗi khi xử lý dữ liệu JSONP:', error);
                showError(`Không thể xử lý dữ liệu. Chi tiết: ${error.message}`);
            }

            // Dọn dẹp: xóa thẻ script và hàm callback sau khi hoàn thành
            document.body.removeChild(scriptTag);
            delete window[callbackName];
        };

        // 3. Tạo một thẻ <script> động để gọi đến Apps Script
        const scriptTag = document.createElement('script');
        
        // 4. Xây dựng URL với các tham số action và callback
        // Lưu ý: Thêm một tham số ngẫu nhiên `&_=` để tránh trình duyệt cache kết quả
        const url = `${KHO_XE_APPS_SCRIPT_URL}?action=getKhoXeData&callback=${callbackName}&_=${new Date().getTime()}`;
        console.log('Đang gọi đến URL:', url);
        
        scriptTag.src = url;
        
        // Xử lý lỗi nếu script không thể tải được (lỗi mạng, URL sai,...)
        scriptTag.onerror = function() {
             console.error('Lỗi khi tải script JSONP. Kiểm tra URL hoặc kết nối mạng.');
             showError('Không thể kết nối đến máy chủ dữ liệu. Vui lòng kiểm tra lại URL trong config.js và kết nối mạng của bạn.');
             document.body.removeChild(scriptTag);
             delete window[callbackName];
        };
        
        // 5. Thêm thẻ script vào trang để trình duyệt thực thi nó
        document.body.appendChild(scriptTag);
    }
    
    // ... (toàn bộ code JS khác của bạn giữ nguyên) ...
</script>