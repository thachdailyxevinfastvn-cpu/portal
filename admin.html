<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị Kho xe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        :root { --brand-color: #1464f4; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-button { transition: all 0.3s; }
        .tab-button.active { color: var(--brand-color); border-color: var(--brand-color); background-color: #eef5ff; }
        .table-container { max-height: 450px; overflow-y: auto; }
        table thead th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; white-space: nowrap; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--brand-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link-active { background-color: #eef2ff; color: #1d4ed8; font-weight: 600; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased text-gray-800">

    <div id="loader-overlay" class="loader-overlay hidden"><div class="loader"></div></div>
    
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="homepage.html" class="text-2xl font-bold text-blue-700">Portal VF</a>
            <div class="hidden md:flex items-center space-x-2">
                <a href="homepage.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Trang chủ</a>
                <a href="khoxe.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Kho xe</a>
                <a href="Yeucaughepxe.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Yêu cầu ghép xe</a>
                <a href="Chinhsach.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Chính sách</a>
                <a href="nganhang.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Ngân hàng</a>
                <a href="KPI.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">KPI</a>
                <a href="Taovanban.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Tạo văn bản</a>
                <a href="admin.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg nav-link-active">Admin</a>
            </div>
            <div class="flex items-center">
                <div id="user-profile" class="flex items-center space-x-3">
                     <span id="user-fullname" class="text-gray-800 font-semibold hidden md:block"></span>
                     <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500">
                </div>
                <button id="logout-btn" class="ml-4 text-gray-500 hover:text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
                <button id="mobile-menu-button" class="md:hidden ml-4 text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t">
            <a href="homepage.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Trang chủ</a>
            <a href="khoxe.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Kho xe</a>
            <a href="Yeucaughepxe.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Yêu cầu ghép xe</a>
            <a href="Chinhsach.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Chính sách</a>
            <a href="nganhang.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ngân hàng</a>
            <a href="KPI.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">KPI</a>
            <a href="Taovanban.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tạo văn bản</a>
            <a href="admin.html" class="block px-4 py-2 text-sm text-gray-700 nav-link-active">Admin</a>
        </div>
    </header>

    <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-5 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Trang Quản Trị Ghép Xe</h1>
                <button onclick="location.reload()" class="flex items-center gap-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                    <i class="fa-solid fa-arrows-rotate"></i> Tải lại
                </button>
            </div>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-ghep-xe" onclick="switchTab('ghep-xe')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-link mr-2"></i>GHÉP XE
                    </button>
                    <button id="tab-doi-xe" onclick="switchTab('doi-xe')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-right-left mr-2"></i>ĐỔI XE
                    </button>
                </nav>
            </div>

            <div id="content-ghep-xe">
                <div class="space-y-8">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Hàng chờ ghép xe</h2>
                        <div id="ghep-xe-waiting-list-container" class="table-container border rounded-lg"></div>
                    </div>
                    
                    <div id="ghep-xe-customer-info" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden"></div>

                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Xe phù hợp trong kho</h2>
                        <div id="ghep-xe-car-results-container" class="table-container border rounded-lg">
                            <div class="p-6 text-center text-gray-500">Vui lòng chọn một khách hàng từ danh sách chờ.</div>
                        </div>
                    </div>

                    <button id="ghep-xe-approve-btn" disabled onclick="approveGhepXe()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> PHÊ DUYỆT GHÉP XE & GỬI EMAIL
                    </button>
                </div>
            </div>

            <div id="content-doi-xe" class="hidden">
                 <div class="space-y-8">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Chọn khách hàng cần đổi xe</h2>
                        <div id="doi-xe-paired-list-container" class="table-container border rounded-lg"></div>
                    </div>
                    
                    <div id="doi-xe-customer-info" class="bg-green-50 p-4 rounded-lg border border-green-200 hidden"></div>
                    
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Tìm và chọn xe mới để đổi</h2>
                        <div id="doi-xe-car-results-container" class="table-container border rounded-lg">
                             <div class="p-6 text-center text-gray-500">Vui lòng chọn một khách hàng từ danh sách đã ghép.</div>
                        </div>
                    </div>
                    
                    <button id="doi-xe-approve-btn" disabled onclick="approveDoiXe()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-retweet"></i> THỰC HIỆN ĐỔI XE & GỬI EMAIL
                    </button>
                </div>
            </div>
        </div>
    </main>
    <script>
        const SCRIPT_URL = KHO_XE_APPS_SCRIPT_URL; 
        let waitingList = [], pairedList = [];
        let selectedWaitingCustomer = null, selectedPairedCustomer = null;
        let selectedCarToPair = null, selectedCarToSwap = null; 
        const showLoader = (show) => document.getElementById('loader-overlay').style.display = show ? 'flex' : 'none';
        const showAlert = (message, isSuccess = true) => alert(message);
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; const day = ('0' + date.getDate()).slice(-2); const month = ('0' + (date.getMonth() + 1)).slice(-2); const year = date.getFullYear(); return `${day}/${month}/${year}`; }
        
        window.onload = async function() {
            const userDataString = sessionStorage.getItem('loggedInUser');
            if (userDataString) {
                const userData = JSON.parse(userDataString);
                document.getElementById('user-fullname').textContent = userData.fullName;
                document.getElementById('user-avatar').src = userData.imageUrl || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${userData.fullName.charAt(0)}`;
            }
             document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            if (typeof SCRIPT_URL === 'undefined' || !SCRIPT_URL) {
                return showAlert("Lỗi cấu hình: KHO_XE_APPS_SCRIPT_URL không tồn tại.", false);
            }
            showLoader(true);
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getAdminData');
                url.searchParams.append('timestamp', new Date().getTime());

                const response = await fetch(url);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const result = await response.json();
                
                if (result.status === 'ERROR') throw new Error(result.message);
                
                const data = result.data || result; 
                waitingList = data.waitingList || [];
                pairedList = data.pairedList || [];
                renderWaitingList();
                renderPairedList();
            } catch (error) {
                showAlert(`Lỗi tải dữ liệu: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        };

        function switchTab(tabName) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function renderWaitingList() {
            const container = document.getElementById('ghep-xe-waiting-list-container');
            if (waitingList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Không có khách hàng nào trong hàng chờ.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase">
                    <tr>
                        <th class="py-3 px-4">Tên KH</th>
                        <th class="py-3 px-4">TVBH</th>
                        <th class="py-3 px-4">Loại Xe</th>
                        <th class="py-3 px-4">Ngoại Thất</th>
                        <th class="py-3 px-4">Nội Thất</th>
                        <th class="py-3 px-4">Ngày Cọc</th>
                        <th class="py-3 px-4"></th>
                    </tr>
                </thead>
                <tbody>`;
            waitingList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH || ''}</td>
                    <td class="py-3 px-4">${c.tvbh || ''}</td>
                    <td class="py-3 px-4">${c.loaiXe || ''}</td>
                    <td class="py-3 px-4">${c.ngoaiThat || ''}</td>
                    <td class="py-3 px-4">${c.noiThat || ''}</td>
                    <td class="py-3 px-4">${c.ngayCoc || ''}</td>
                    <td class="py-3 px-4 text-right">
                        <button onclick="selectWaitingCustomer('${c.uniqueId}')" class="font-medium text-blue-600 hover:underline">Chọn</button>
                    </td>
                </tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        async function selectWaitingCustomer(uniqueId) {
            selectedWaitingCustomer = waitingList.find(c => c.uniqueId === uniqueId);
            if (!selectedWaitingCustomer) return;
            document.querySelectorAll('#ghep-xe-waiting-list-container tr').forEach(r => r.classList.remove('bg-blue-100'));
            document.querySelector(`button[onclick="selectWaitingCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-blue-100');
            const infoDiv = document.getElementById('ghep-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-blue-800">Đang tìm xe cho: ${selectedWaitingCustomer.tenKH}</h3>
                                 <p class="text-sm text-blue-700 mt-1">
                                    ${selectedWaitingCustomer.loaiXe} - ${selectedWaitingCustomer.phienBan} - ${selectedWaitingCustomer.ngoaiThat} - ${selectedWaitingCustomer.noiThat}
                                 </p>`;
            infoDiv.classList.remove('hidden');
            selectedCarToPair = null;
            document.getElementById('ghep-xe-approve-btn').disabled = true;
            document.getElementById('ghep-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">Đang tìm xe...</div>`;
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'findCars', params: selectedWaitingCustomer })
                });
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                renderCarResults(result.data, 'ghep-xe-car-results-container', 'selectedCarToPair', 'selectCarToPair');
            } catch (error) {
                showAlert(`Lỗi khi tìm xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }

        function selectCarToPair(carObject) {
            selectedCarToPair = carObject;
            document.getElementById('ghep-xe-approve-btn').disabled = false;
        }

        async function approveGhepXe() {
            if (!selectedWaitingCustomer || !selectedCarToPair) return showAlert('Vui lòng chọn khách hàng và xe.', false);
            if (!confirm(`Bạn chắc chắn muốn ghép xe có VIN ${selectedCarToPair.soVin} cho khách hàng ${selectedWaitingCustomer.tenKH}?`)) return;
            const ghepXeInfo = { carVin: selectedCarToPair.soVin, customerUniqueId: selectedWaitingCustomer.uniqueId };
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'processGhepXe', params: ghepXeInfo })
                });
                const result = await response.json();
                if (result.status !== 'SUCCESS') throw new Error(result.message);
                showAlert(result.message, true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                showAlert(`Lỗi khi ghép xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }
        
        function renderPairedList() {
            const container = document.getElementById('doi-xe-paired-list-container');
            if (pairedList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Chưa có khách hàng nào được ghép xe.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase">
                    <tr>
                        <th class="py-3 px-4">Tên KH</th>
                        <th class="py-3 px-4">TVBH</th>
                        <th class="py-3 px-4">Loại Xe (VIN)</th>
                        <th class="py-3 px-4">Ngoại Thất</th>
                        <th class="py-3 px-4">Nội Thất</th>
                        <th class="py-3 px-4">Ngày Cọc</th>
                        <th class="py-3 px-4"></th>
                    </tr>
                </thead>
                <tbody>`;
            pairedList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH || ''}</td>
                    <td class="py-3 px-4">${c.tvbh || ''}</td>
                    <td class="py-3 px-4">${c.loaiXe || ''}<div class="text-xs text-gray-500 font-mono">${c.soVin || ''}</div></td>
                    <td class="py-3 px-4">${c.ngoaiThat || ''}</td>
                    <td class="py-3 px-4">${c.noiThat || ''}</td>
                    <td class="py-3 px-4">${c.ngayCoc || ''}</td>
                    <td class="py-3 px-4 text-right">
                        <button onclick="selectPairedCustomer('${c.uniqueId}')" class="font-medium text-green-600 hover:underline">Chọn</button>
                    </td>
                </tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }
        
        async function selectPairedCustomer(uniqueId) {
            selectedPairedCustomer = pairedList.find(c => c.uniqueId === uniqueId);
            if (!selectedPairedCustomer) return;
            document.querySelectorAll('#doi-xe-paired-list-container tr').forEach(r => r.classList.remove('bg-green-100'));
            document.querySelector(`button[onclick="selectPairedCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-green-100');
            const infoDiv = document.getElementById('doi-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-green-800">Đổi xe cho: ${selectedPairedCustomer.tenKH}</h3><p class="text-sm text-green-700 mt-1">Xe hiện tại: ${selectedPairedCustomer.loaiXe} - VIN: ${selectedPairedCustomer.soVin}</p>`;
            infoDiv.classList.remove('hidden');
            selectedCarToSwap = null;
            document.getElementById('doi-xe-approve-btn').disabled = true;
            document.getElementById('doi-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">Đang tìm xe...</div>`;
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'findCars', params: {} })
                });
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                renderCarResults(result.data, 'doi-xe-car-results-container', 'selectedCarToSwap', 'selectCarToSwap');
            } catch (error) {
                showAlert(`Lỗi khi tìm xe để đổi: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }
        
        function selectCarToSwap(carObject) {
            selectedCarToSwap = carObject;
            document.getElementById('doi-xe-approve-btn').disabled = false;
        }

        async function approveDoiXe() {
            if (!selectedPairedCustomer || !selectedCarToSwap) return showAlert('Vui lòng chọn khách hàng và xe mới.', false);
            if (!confirm(`Bạn chắc chắn muốn đổi xe cho ${selectedPairedCustomer.tenKH} sang xe mới có VIN ${selectedCarToSwap.soVin}?`)) return;
            const doiXeInfo = { oldCarVin: selectedPairedCustomer.soVin, newCarVin: selectedCarToSwap.soVin };
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'processDoiXe', params: doiXeInfo })
                });
                const result = await response.json();
                if (result.status !== 'SUCCESS') throw new Error(result.message);
                showAlert(result.message, true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                showAlert(`Lỗi khi đổi xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }

        function renderCarResults(cars, containerId, radioName, onchangeFunction) {
            const container = document.getElementById(containerId);
            if (!cars || cars.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Không tìm thấy xe nào phù hợp.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase">
                    <tr>
                        <th class="py-3 px-2">Chọn</th>
                        <th class="py-3 px-2">Số VIN</th>
                        <th class="py-3 px-2">Số Máy</th>
                        <th class="py-3 px-2">PO</th>
                        <th class="py-3 px-2">Loại Xe</th>
                        <th class="py-3 px-2">Nội thất</th>
                        <th class="py-3 px-2">Ngày Về</th>
                        <th class="py-3 px-2">Ghi Chú</th>
                        <th class="py-3 px-2">Kho</th>
                    </tr>
                </thead>
                <tbody>`;
            cars.forEach(car => {
                if (radioName === 'selectedCarToSwap' && selectedPairedCustomer && car.soVin && car.soVin === selectedPairedCustomer.soVin) return;

                const carData = JSON.stringify(car).replace(/"/g, '&quot;');
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-2 px-2"><input type="radio" name="${radioName}" onchange="${onchangeFunction}(${carData})"></td>
                    <td class="py-2 px-2 font-semibold text-gray-900">${car.soVin || ''}</td>
                    <td class="py-2 px-2">${car.soMay || ''}</td>
                    <td class="py-2 px-2">${car.po || ''}</td>
                    <td class="py-2 px-2">${car.loaiXe || ''}<div class="text-xs text-gray-500">${car.phienBan || ''}</div><div class="font-medium">${car.ngoaiThat || ''}</div></td>
                    <td class="py-2 px-2">${car.noiThat || ''}</td>
                    <td class="py-2 px-2">${formatDate(car.ngayVe)}</td>
                    <td class="py-2 px-2">${car.ghiChu || ''}</td>
                    <td class="py-2 px-2">${car.kho || ''}</td>
                </tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }
    </script>
</body>
</html>