<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã Kho xe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        :root { --brand-color: #1464f4; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-button { transition: all 0.3s; }
        .tab-button.active { color: var(--brand-color); border-color: var(--brand-color); background-color: #eef5ff; }
        .table-container { max-height: 400px; overflow-y: auto; }
        table thead th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; white-space: nowrap; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--brand-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-6">

    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-5 md:p-8">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">üöò Qu·∫£n Tr·ªã Kho Xe</h1>
                <p class="text-gray-500 mt-1">Giao di·ªán qu·∫£n l√Ω gh√©p xe, ho√°n ƒë·ªïi v√† g·ª≠i email th√¥ng b√°o.</p>
            </div>
            <button onclick="location.reload()" class="mt-4 md:mt-0 flex items-center gap-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                <i class="fa-solid fa-arrows-rotate"></i>
                T·∫£i l·∫°i d·ªØ li·ªáu
            </button>
        </div>

        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-ghep-xe" onclick="switchTab('ghep-xe')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-link mr-2"></i>GH√âP XE
                </button>
                <button id="tab-doi-xe" onclick="switchTab('doi-xe')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-right-left mr-2"></i>ƒê·ªîI XE
                </button>
            </nav>
        </div>

        <div id="content-ghep-xe">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. H√†ng ch·ªù gh√©p xe</h2>
                    <div id="ghep-xe-waiting-list-container" class="table-container border rounded-lg"></div>
                </div>
                <div>
                    <div id="ghep-xe-customer-info" class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200 hidden"></div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Xe ph√π h·ª£p trong kho</h2>
                    <div id="ghep-xe-car-results-container" class="table-container border rounded-lg">
                        <div class="p-6 text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch ch·ªù.</div>
                    </div>
                    <button id="ghep-xe-approve-btn" disabled onclick="approveGhepXe()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> PH√ä DUY·ªÜT GH√âP XE & G·ª¨I EMAIL
                    </button>
                </div>
            </div>
        </div>

        <div id="content-doi-xe" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Ch·ªçn kh√°ch h√†ng c·∫ßn ƒë·ªïi xe</h2>
                    <div id="doi-xe-paired-list-container" class="table-container border rounded-lg"></div>
                </div>
                <div>
                    <div id="doi-xe-customer-info" class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200 hidden"></div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. T√¨m v√† ch·ªçn xe m·ªõi ƒë·ªÉ ƒë·ªïi</h2>
                    <div id="doi-xe-car-results-container" class="table-container border rounded-lg">
                         <div class="p-6 text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch ƒë√£ gh√©p.</div>
                    </div>
                    <button id="doi-xe-approve-btn" disabled onclick="approveDoiXe()" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-retweet"></i> TH·ª∞C HI·ªÜN ƒê·ªîI XE & G·ª¨I EMAIL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = KHO_XE_APPS_SCRIPT_URL; 
        let waitingList = [], pairedList = [];
        let selectedWaitingCustomer = null, selectedPairedCustomer = null;
        let selectedCarToPair = null, selectedCarToSwap = null; 

        const showLoader = (show) => document.getElementById('loader-overlay').style.display = show ? 'flex' : 'none';
        const showAlert = (message, isSuccess = true) => alert(message);

        // === THAY ƒê·ªîI: B·ªï sung h√†m ƒë·ªãnh d·∫°ng ng√†y th√°ng ===
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Tr·∫£ v·ªÅ chu·ªói g·ªëc n·∫øu kh√¥ng ph·∫£i ng√†y h·ª£p l·ªá
            const day = ('0' + date.getDate()).slice(-2);
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        window.onload = async function() {
            if (typeof SCRIPT_URL === 'undefined' || !SCRIPT_URL) {
                showAlert("L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y KHO_XE_APPS_SCRIPT_URL trong file config.js.", false);
                return;
            }
            showLoader(true);
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getAdminData');
                const response = await fetch(url);
                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                
                const data = result.data;
                waitingList = data.waitingList || [];
                pairedList = data.pairedList || [];
                renderWaitingList();
                renderPairedList();
            } catch (error) {
                showAlert(`ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu: ${error.message}`, false);
                console.error("L·ªói t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:", error);
            } finally {
                showLoader(false);
            }
        };

        function switchTab(tabName) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function renderWaitingList() {
            // ... (H√†m n√†y gi·ªØ nguy√™n)
            const container = document.getElementById('ghep-xe-waiting-list-container');
            if (waitingList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Kh√¥ng c√≥ kh√°ch h√†ng n√†o trong h√†ng ch·ªù.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4">T√™n KH</th><th class="py-3 px-4">Lo·∫°i Xe</th><th class="py-3 px-4">TVBH</th><th class="py-3 px-4"></th></tr></thead><tbody>`;
            waitingList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH}</td><td class="py-3 px-4">${c.loaiXe}</td><td class="py-3 px-4">${c.tvbh}</td><td class="py-3 px-4 text-right"><button onclick="selectWaitingCustomer('${c.uniqueId}')" class="font-medium text-blue-600 hover:underline">Ch·ªçn</button></td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        async function selectWaitingCustomer(uniqueId) {
            selectedWaitingCustomer = waitingList.find(c => c.uniqueId === uniqueId);
            if (!selectedWaitingCustomer) return;
            document.querySelectorAll('#ghep-xe-waiting-list-container tr').forEach(r => r.classList.remove('bg-blue-100'));
            document.querySelector(`button[onclick="selectWaitingCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-blue-100');
            const infoDiv = document.getElementById('ghep-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-blue-800">ƒêang t√¨m xe cho: ${selectedWaitingCustomer.tenKH}</h3><p class="text-sm text-blue-700 mt-1">${selectedWaitingCustomer.loaiXe} - ${selectedWaitingCustomer.phienBan} - ${selectedWaitingCustomer.ngoaiThat}</p>`;
            infoDiv.classList.remove('hidden');
            selectedCarToPair = null;
            document.getElementById('ghep-xe-approve-btn').disabled = true;
            document.getElementById('ghep-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">ƒêang t√¨m xe...</div>`;
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'findCars', params: selectedWaitingCustomer })
                });
                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                renderCarResults(result.data, 'ghep-xe-car-results-container', 'selectedCarToPair', 'selectCarToPair');
            } catch (error) {
                showAlert(`L·ªói khi t√¨m xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }

        function selectCarToPair(carObject) {
            selectedCarToPair = carObject;
            document.getElementById('ghep-xe-approve-btn').disabled = false;
        }

        async function approveGhepXe() {
            if (!selectedWaitingCustomer || !selectedCarToPair) return showAlert('Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† xe.', false);
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën gh√©p xe c√≥ VIN ${selectedCarToPair.soVin} cho kh√°ch h√†ng ${selectedWaitingCustomer.tenKH}?`)) return;
            const ghepXeInfo = { carRow: selectedCarToPair.row, carSheetName: selectedCarToPair.sheetName, customerUniqueId: selectedWaitingCustomer.uniqueId };
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'processGhepXe', params: ghepXeInfo })
                });
                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                const result = await response.json();
                if (result.status !== 'SUCCESS') throw new Error(result.message);
                showAlert(result.message, true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                showAlert(`L·ªói khi gh√©p xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }
        
        // --- ƒê·ªîI XE LOGIC ---
        function renderPairedList() {
            const container = document.getElementById('doi-xe-paired-list-container');
            if (pairedList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Ch∆∞a c√≥ kh√°ch h√†ng n√†o ƒë∆∞·ª£c gh√©p xe.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4">T√™n KH</th><th class="py-3 px-4">Xe hi·ªán t·∫°i (VIN)</th><th class="py-3 px-4">TVBH</th><th class="py-3 px-4"></th></tr></thead><tbody>`;
            pairedList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH}</td><td class="py-3 px-4">${c.soVin}</td><td class="py-3 px-4">${c.tvbh}</td><td class="py-3 px-4 text-right"><button onclick="selectPairedCustomer('${c.uniqueId}')" class="font-medium text-green-600 hover:underline">Ch·ªçn</button></td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        async function selectPairedCustomer(uniqueId) {
            selectedPairedCustomer = pairedList.find(c => c.uniqueId === uniqueId);
            if (!selectedPairedCustomer) return;
            document.querySelectorAll('#doi-xe-paired-list-container tr').forEach(r => r.classList.remove('bg-green-100'));
            document.querySelector(`button[onclick="selectPairedCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-green-100');
            const infoDiv = document.getElementById('doi-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-green-800">ƒê·ªïi xe cho: ${selectedPairedCustomer.tenKH}</h3><p class="text-sm text-green-700 mt-1">Xe hi·ªán t·∫°i: ${selectedPairedCustomer.loaiXe} - VIN: ${selectedPairedCustomer.soVin}</p>`;
            infoDiv.classList.remove('hidden');
            selectedCarToSwap = null;
            document.getElementById('doi-xe-approve-btn').disabled = true;
            document.getElementById('doi-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">ƒêang t√¨m xe...</div>`;
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'findCars', params: {} })
                });
                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                renderCarResults(result.data, 'doi-xe-car-results-container', 'selectedCarToSwap', 'selectCarToSwap');
            } catch (error) {
                showAlert(`L·ªói khi t√¨m xe ƒë·ªÉ ƒë·ªïi: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }
        
        function selectCarToSwap(carObject) {
            selectedCarToSwap = carObject;
            document.getElementById('doi-xe-approve-btn').disabled = false;
        }

        async function approveDoiXe() {
            if (!selectedPairedCustomer || !selectedCarToSwap) return showAlert('Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† xe m·ªõi.', false);
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·ªïi xe cho ${selectedPairedCustomer.tenKH} sang xe m·ªõi c√≥ VIN ${selectedCarToSwap.soVin}?`)) return;
            const doiXeInfo = { oldCarSheetRow: selectedPairedCustomer.sheetRow, newCarRow: selectedCarToSwap.row, newCarSheetName: selectedCarToSwap.sheetName };
            showLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'processDoiXe', params: doiXeInfo })
                });
                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                const result = await response.json();
                if (result.status !== 'SUCCESS') throw new Error(result.message);
                showAlert(result.message, true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                showAlert(`L·ªói khi ƒë·ªïi xe: ${error.message}`, false);
            } finally {
                showLoader(false);
            }
        }

        // === THAY ƒê·ªîI: H√ÄM HI·ªÇN TH·ªä K·∫æT QU·∫¢ T√åM XE D√ôNG CHUNG ===
        function renderCarResults(cars, containerId, radioName, onchangeFunction) {
            const container = document.getElementById(containerId);
            if (!cars || cars.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y xe n√†o ph√π h·ª£p.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase">
                    <tr>
                        <th class="py-3 px-2">Ch·ªçn</th>
                        <th class="py-3 px-2">S·ªë VIN</th>
                        <th class="py-3 px-2">S·ªë M√°y</th>
                        <th class="py-3 px-2">PO</th>
                        <th class="py-3 px-2">Lo·∫°i Xe</th>
                        <th class="py-3 px-2">N·ªôi th·∫•t</th>
                        <th class="py-3 px-2">Ng√†y V·ªÅ</th>
                        <th class="py-3 px-2">Ghi Ch√∫</th>
                        <th class="py-3 px-2">Kho</th>
                    </tr>
                </thead>
                <tbody>`;
            cars.forEach(car => {
                // L·ªçc ra xe hi·ªán t·∫°i c·ªßa kh√°ch h√†ng trong ch·ª©c nƒÉng ƒê·ªïi xe
                if (radioName === 'selectedCarToSwap' && selectedPairedCustomer && car.soVin && car.soVin === selectedPairedCustomer.soVin) return;

                const carData = JSON.stringify(car).replace(/"/g, '&quot;');
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-2 px-2"><input type="radio" name="${radioName}" onchange="${onchangeFunction}(${carData})"></td>
                    <td class="py-2 px-2 font-semibold text-gray-900">${car.soVin || ''}</td>
                    <td class="py-2 px-2">${car.soMay || ''}</td>
                    <td class="py-2 px-2">${car.po || ''}</td>
                    <td class="py-2 px-2">${car.loaiXe || ''}<div class="text-xs text-gray-500">${car.phienBan || ''}</div><div class="font-medium">${car.ngoaiThat || ''}</div></td>
                    <td class="py-2 px-2">${car.noiThat || ''}</td>
                    <td class="py-2 px-2">${formatDate(car.ngayVe)}</td>
                    <td class="py-2 px-2">${car.ghiChu || ''}</td>
                    <td class="py-2 px-2">${car.kho || ''}</td>
                </tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }
    </script>
</body>
</html>