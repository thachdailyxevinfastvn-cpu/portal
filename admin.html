<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã Kho xe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- N·∫°p t·ªáp c·∫•u h√¨nh API -->
    <script src="config.js"></script>
    <style>
        :root { --brand-color: #1464f4; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-button { transition: all 0.3s; }
        .tab-button.active { color: var(--brand-color); border-color: var(--brand-color); background-color: #eef5ff; }
        .table-container { max-height: 400px; overflow-y: auto; }
        table thead th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--brand-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-6">

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-5 md:p-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">üöò Qu·∫£n Tr·ªã Kho Xe</h1>
                <p class="text-gray-500 mt-1">Giao di·ªán qu·∫£n l√Ω gh√©p xe v√† ho√°n ƒë·ªïi xe chuy√™n nghi·ªáp.</p>
            </div>
            <button onclick="location.reload()" class="mt-4 md:mt-0 flex items-center gap-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                <i class="fa-solid fa-arrows-rotate"></i>
                T·∫£i l·∫°i d·ªØ li·ªáu
            </button>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-ghep-xe" onclick="switchTab('ghep-xe')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-link mr-2"></i>GH√âP XE
                </button>
                <button id="tab-doi-xe" onclick="switchTab('doi-xe')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-right-left mr-2"></i>ƒê·ªîI XE
                </button>
            </nav>
        </div>

        <!-- Tab Content: Ghep Xe -->
        <div id="content-ghep-xe">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Column 1: Waiting List -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. H√†ng ch·ªù gh√©p xe</h2>
                    <div id="ghep-xe-waiting-list-container" class="table-container border rounded-lg"></div>
                </div>
                <!-- Column 2: Car Search & Approval -->
                <div>
                    <div id="ghep-xe-customer-info" class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200 hidden"></div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Xe ph√π h·ª£p trong kho</h2>
                    <div id="ghep-xe-car-results-container" class="table-container border rounded-lg">
                        <div class="p-6 text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch ch·ªù.</div>
                    </div>
                    <button id="ghep-xe-approve-btn" disabled onclick="approveGhepXe()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> PH√ä DUY·ªÜT GH√âP XE
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content: Doi Xe -->
        <div id="content-doi-xe" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Column 1: Paired List -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Ch·ªçn kh√°ch h√†ng c·∫ßn ƒë·ªïi xe</h2>
                    <div id="doi-xe-paired-list-container" class="table-container border rounded-lg"></div>
                </div>
                <!-- Column 2: New Car Search & Swap -->
                <div>
                    <div id="doi-xe-customer-info" class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200 hidden"></div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. T√¨m v√† ch·ªçn xe m·ªõi ƒë·ªÉ ƒë·ªïi</h2>
                    <div id="doi-xe-car-results-container" class="table-container border rounded-lg">
                         <div class="p-6 text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch ƒë√£ gh√©p.</div>
                    </div>
                    <button id="doi-xe-approve-btn" disabled onclick="approveDoiXe()" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-retweet"></i> TH·ª∞C HI·ªÜN ƒê·ªîI XE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // S·ª≠ d·ª•ng URL t·ª´ t·ªáp config.js
        const SCRIPT_URL = KHO_XE_APPS_SCRIPT_URL; 

        // Global state
        let waitingList = [];
        let pairedList = [];
        let selectedWaitingCustomer = null;
        let selectedPairedCustomer = null;
        let selectedCarToPairRow = null;
        let selectedCarToSwapRow = null;

        // --- UTILITY FUNCTIONS ---
        const showLoader = () => document.getElementById('loader-overlay').classList.remove('hidden');
        const hideLoader = () => document.getElementById('loader-overlay').classList.add('hidden');
        const showAlert = (message, isSuccess = true) => alert(message);

        // --- API HELPER ---
        async function apiCall(method, action, params = {}) {
            showLoader();
            try {
                let response;
                if (method.toUpperCase() === 'GET') {
                    const url = new URL(SCRIPT_URL);
                    url.searchParams.append('action', action);
                    response = await fetch(url);
                } else { // POST
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        redirect: 'follow', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action, params })
                    });
                }

                if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
                
                // X·ª≠ l√Ω ph·∫£n h·ªìi m·ªôt c√°ch an to√†n h∆°n
                const responseText = await response.text();
                if (!responseText) {
                    // N·∫øu ph·∫£n h·ªìi r·ªóng (th∆∞·ªùng x·∫£y ra v·ªõi POST th√†nh c√¥ng), tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng m·∫∑c ƒë·ªãnh
                    return { success: true, message: "Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω." };
                }

                const result = JSON.parse(responseText);
                if (result.status === 'ERROR') throw new Error(result.message);
                return result.data;

            } catch (error) {
                // Ph√¢n t√≠ch l·ªói c·ª• th·ªÉ h∆°n
                if (error instanceof SyntaxError) {
                    // L·ªói n√†y x·∫£y ra khi JSON.parse th·∫•t b·∫°i, th∆∞·ªùng l√† do ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON
                    console.error("L·ªói ph√¢n t√≠ch JSON. Ph·∫£n h·ªìi t·ª´ server:", error);
                    showAlert("ƒê√£ x·∫£y ra l·ªói khi ƒë·ªçc ph·∫£n h·ªìi t·ª´ m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra Console.", false);
                } else {
                    showAlert(`ƒê√£ x·∫£y ra l·ªói: ${error.message}`, false);
                }
                throw error;
            } finally {
                hideLoader();
            }
        }
        
        // --- INITIAL DATA LOADING ---
        window.onload = async function() {
            if (typeof KHO_XE_APPS_SCRIPT_URL === 'undefined' || !KHO_XE_APPS_SCRIPT_URL) {
                showAlert("L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y KHO_XE_APPS_SCRIPT_URL. H√£y ƒë·∫£m b·∫£o t·ªáp config.js ƒë√£ ƒë∆∞·ª£c n·∫°p ƒë√∫ng.", false);
                return;
            }
            try {
                const data = await apiCall('GET', 'getAdminData');
                waitingList = data.waitingList || [];
                pairedList = data.pairedList || [];
                renderWaitingList();
                renderPairedList();
            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:", error);
            }
        };

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // --- GH√âP XE LOGIC ---
        function renderWaitingList() {
            const container = document.getElementById('ghep-xe-waiting-list-container');
            if (waitingList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Kh√¥ng c√≥ kh√°ch h√†ng n√†o trong h√†ng ch·ªù.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4">T√™n KH</th><th class="py-3 px-4">Lo·∫°i Xe</th><th class="py-3 px-4">TVBH</th><th class="py-3 px-4"></th></tr></thead><tbody>`;
            waitingList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH}</td><td class="py-3 px-4">${c.loaiXe}</td><td class="py-3 px-4">${c.tvbh}</td><td class="py-3 px-4 text-right"><button onclick="selectWaitingCustomer('${c.uniqueId}')" class="font-medium text-blue-600 hover:underline">Ch·ªçn</button></td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        async function selectWaitingCustomer(uniqueId) {
            selectedWaitingCustomer = waitingList.find(c => c.uniqueId === uniqueId);
            if (!selectedWaitingCustomer) return;

            document.querySelectorAll('#ghep-xe-waiting-list-container tr').forEach(r => r.classList.remove('bg-blue-100'));
            document.querySelector(`button[onclick="selectWaitingCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-blue-100');

            const infoDiv = document.getElementById('ghep-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-blue-800">ƒêang t√¨m xe cho: ${selectedWaitingCustomer.tenKH}</h3><p class="text-sm text-blue-700 mt-1">${selectedWaitingCustomer.loaiXe} - ${selectedWaitingCustomer.phienBan} - ${selectedWaitingCustomer.ngoaiThat}</p>`;
            infoDiv.classList.remove('hidden');

            selectedCarToPairRow = null;
            document.getElementById('ghep-xe-approve-btn').disabled = true;
            document.getElementById('ghep-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">ƒêang t√¨m xe...</div>`;
            
            try {
                const cars = await apiCall('POST', 'findCars', selectedWaitingCustomer);
                renderCarResultsForPairing(cars);
            } catch (error) { /* Handled in apiCall */ }
        }

        function renderCarResultsForPairing(cars) {
            const container = document.getElementById('ghep-xe-car-results-container');
            if (!cars || cars.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y xe n√†o ph√π h·ª£p.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4 w-12">Ch·ªçn</th><th class="py-3 px-4">S·ªë VIN</th><th class="py-3 px-4">Phi√™n b·∫£n</th><th class="py-3 px-4">M√†u s·∫Øc</th></tr></thead><tbody>`;
            cars.forEach(car => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="py-3 px-4"><input type="radio" name="selectedCarToPair" onchange="selectCarToPair(${car.row})"></td>
                    <td class="py-3 px-4 font-semibold text-gray-900">${car.soVin}</td>
                    <td class="py-3 px-4">${car.phienBan}</td>
                    <td class="py-3 px-4">${car.ngoaiThat}</td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }
        
        function selectCarToPair(carRow) {
            selectedCarToPairRow = carRow;
            document.getElementById('ghep-xe-approve-btn').disabled = false;
        }

        async function approveGhepXe() {
            if (!selectedWaitingCustomer || !selectedCarToPairRow) return showAlert('Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† xe.', false);
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën gh√©p xe (d√≤ng ${selectedCarToPairRow}) cho kh√°ch h√†ng ${selectedWaitingCustomer.tenKH}?`)) return;
            
            const ghepXeInfo = { carRow: selectedCarToPairRow, customerName: selectedWaitingCustomer.tenKH };
            try {
                await apiCall('POST', 'processGhepXe', ghepXeInfo);
                showAlert("Y√™u c·∫ßu gh√©p xe ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng. Trang s·∫Ω t·ª± ƒë·ªông t·∫£i l·∫°i.", true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) { /* Handled */ }
        }

        // --- ƒê·ªîI XE LOGIC ---
        function renderPairedList() {
            const container = document.getElementById('doi-xe-paired-list-container');
            if (pairedList.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Ch∆∞a c√≥ kh√°ch h√†ng n√†o ƒë∆∞·ª£c gh√©p xe.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4">T√™n KH</th><th class="py-3 px-4">Xe hi·ªán t·∫°i (VIN)</th><th class="py-3 px-4">TVBH</th><th class="py-3 px-4"></th></tr></thead><tbody>`;
            pairedList.forEach(c => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4 font-semibold text-gray-900">${c.tenKH}</td><td class="py-3 px-4">${c.soVin}</td><td class="py-3 px-4">${c.tvbh}</td><td class="py-3 px-4 text-right"><button onclick="selectPairedCustomer('${c.uniqueId}')" class="font-medium text-green-600 hover:underline">Ch·ªçn</button></td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        async function selectPairedCustomer(uniqueId) {
            selectedPairedCustomer = pairedList.find(c => c.uniqueId === uniqueId);
            if (!selectedPairedCustomer) return;

            document.querySelectorAll('#doi-xe-paired-list-container tr').forEach(r => r.classList.remove('bg-green-100'));
            document.querySelector(`button[onclick="selectPairedCustomer('${uniqueId}')"]`).closest('tr').classList.add('bg-green-100');

            const infoDiv = document.getElementById('doi-xe-customer-info');
            infoDiv.innerHTML = `<h3 class="font-bold text-green-800">ƒê·ªïi xe cho: ${selectedPairedCustomer.tenKH}</h3><p class="text-sm text-green-700 mt-1">Xe hi·ªán t·∫°i: ${selectedPairedCustomer.loaiXe} - VIN: ${selectedPairedCustomer.soVin}</p>`;
            infoDiv.classList.remove('hidden');

            selectedCarToSwapRow = null;
            document.getElementById('doi-xe-approve-btn').disabled = true;
            document.getElementById('doi-xe-car-results-container').innerHTML = `<div class="p-6 text-center text-gray-500">ƒêang t√¨m xe...</div>`;
            
            try {
                const cars = await apiCall('POST', 'findCars', {}); // Empty filter gets all cars
                renderCarResultsForSwapping(cars);
            } catch (error) { /* Handled */ }
        }
        
        function renderCarResultsForSwapping(cars) {
            const container = document.getElementById('doi-xe-car-results-container');
            if (!cars || cars.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Kh√¥ng c√≥ xe n√†o trong kho ƒë·ªÉ ƒë·ªïi.</div>`;
                return;
            }
            let tableHtml = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase"><tr><th class="py-3 px-4 w-12">Ch·ªçn</th><th class="py-3 px-4">S·ªë VIN</th><th class="py-3 px-4">Lo·∫°i Xe</th><th class="py-3 px-4">M√†u s·∫Øc</th></tr></thead><tbody>`;
            cars.forEach(car => {
                tableHtml += `<tr class="bg-white border-b hover:bg-gray-50"><td class="py-3 px-4"><input type="radio" name="selectedCarToSwap" onchange="selectCarToSwap(${car.row})"></td><td class="py-3 px-4 font-semibold text-gray-900">${car.soVin}</td><td class="py-3 px-4">${car.loaiXe}</td><td class="py-3 px-4">${car.ngoaiThat}</td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table>`;
        }

        function selectCarToSwap(carRow) {
            selectedCarToSwapRow = carRow;
            document.getElementById('doi-xe-approve-btn').disabled = false;
        }

        async function approveDoiXe() {
            if (!selectedPairedCustomer || !selectedCarToSwapRow) return showAlert('Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† xe m·ªõi.', false);
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·ªïi xe cho ${selectedPairedCustomer.tenKH} sang xe m·ªõi (d√≤ng ${selectedCarToSwapRow})?`)) return;

            const doiXeInfo = { customerName: selectedPairedCustomer.tenKH, newCarRow: selectedCarToSwapRow };
            try {
                await apiCall('POST', 'processDoiXe', doiXeInfo);
                showAlert("Y√™u c·∫ßu ƒë·ªïi xe ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng. Trang s·∫Ω t·ª± ƒë·ªông t·∫£i l·∫°i.", true);
                setTimeout(() => location.reload(), 1500);
            } catch (error) { /* Handled */ }
        }
    </script>
</body>
</html>
