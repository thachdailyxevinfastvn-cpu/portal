<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý - Portal VF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .tab-active { border-color: #1d4ed8; color: #1d4ed8; background-color: white; font-weight: 600; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #a8b3c4; }
        .clickable-row:hover { background-color: #eff6ff; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-50">
            </header>

        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Quản Lý Kinh Doanh</h1>
            
            <div id="loading-state" class="flex flex-col items-center justify-center py-20">
                </div>

            <div id="content-wrapper" class="hidden">
                 <div class="mb-6 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                            <input type="date" id="start-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                            <input type="date" id="end-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500">
                        </div>
                        <button id="filter-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-filter mr-2"></i>Xem
                        </button>
                    </div>
                     <div class="items-end flex">
                        <div class="w-full">
                             <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm thông minh</label>
                             <div class="relative">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                                 <input type="text" id="search-input" placeholder="Nhập thông tin cần tìm..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                             </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav id="tabs-container" class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs"></nav>
                    </div>
                </div>

                <div id="tab-contents-wrapper">
                    <div id="dashboard-content" class="tab-content space-y-8"></div>
                    <div id="donton-content" class="tab-content"></div>
                    <div id="ky-content" class="tab-content"></div>
                    <div id="xuat-content" class="tab-content"></div>
                    <div id="congno-content" class="tab-content"></div>
                    <div id="coc-content" class="tab-content"></div>
                    <div id="dagiao-content" class="tab-content"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="config.js"></script>
    <script>
        // === KHAI BÁO BIẾN & DOM ELEMENTS ===
        let allData = { hopDong: [], nhanSu: [], cacNguon: [] };
        let filteredData = [];
        let activeTab = 'dashboard';

        // [SỬA LỖI] ĐỊNH NGHĨA ĐẦY ĐỦ CHO TABCONFIG
        const tabConfig = {
            'dashboard': { name: 'Dashboard', renderFunc: renderDashboardTab },
            'donton': { name: 'Đơn tồn chưa xuất', renderFunc: renderDonTonTab },
            'ky': { name: 'Ký', renderFunc: () => genericRenderWrapper('ky-content', 'Ký', hd => hd.tt1) },
            'xuat': { name: 'Xuất', renderFunc: () => genericRenderWrapper('xuat-content', 'Xuất', hd => hd.ngày_xhđ) },
            'congno': { name: 'Công nợ', renderFunc: renderCongNoTab },
            'coc': { name: 'Theo dõi COC', renderFunc: renderCocTab },
            'dagiao': { name: 'Đã giao', renderFunc: () => genericRenderWrapper('dagiao-content', 'Đã giao', hd => hd.ngày_giao_xe) },
        };

        // [SỬA LỖI] KHAI BÁO ĐẦY ĐỦ CÁC DOM ELEMENTS
        const loadingState = document.getElementById('loading-state');
        const contentWrapper = document.getElementById('content-wrapper');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const searchInput = document.getElementById('search-input');

        // === UTILITY FUNCTION ===
        function formatDate(isoString) {
            if (!isoString || !String(isoString).includes('T')) return isoString || '';
            try {
                return new Date(isoString).toLocaleDateString('vi-VN');
            } catch (e) {
                return isoString;
            }
        }

        // === KHỞI TẠO & LẤY DỮ LIỆU ===
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            document.getElementById('filter-btn').addEventListener('click', () => renderActiveTab());
            searchInput.addEventListener('input', () => {
                applySearchFilter();
                renderActiveTab();
            });
        });
        
        // [SỬA LỖI] BỔ SUNG HÀM FETCHDATA HOÀN CHỈNH
        function fetchData() {
             try {
                window.handleDashboardResponse = (result) => {
                    if (result.status === 'ERROR') { throw new Error(result.message); }
                    allData = result.data;
                    initializeApp();
                };
                const script = document.createElement('script');
                script.src = `${QUAN_LY_APPS_SCRIPT_URL}?action=getDashboardData&callback=handleDashboardResponse`;
                script.onerror = () => { console.error('Không thể tải script từ Google.'); };
                script.onload = () => { document.body.removeChild(script); delete window.handleDashboardResponse; };
                document.body.appendChild(script);
            } catch (error) {
                console.error(error);
            }
        }

        // [SỬA LỖI] BỔ SUNG HÀM INITIALIZEAPP HOÀN CHỈNH
        function initializeApp() {
            loadingState.style.display = 'none';
            contentWrapper.classList.remove('hidden');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = firstDayOfMonth;
            renderTabs();
            setActiveTab('dashboard');
        }

        // === LOGIC TABS, BỘ LỌC, TÌM KIẾM ===
        
        // [SỬA LỖI] BỔ SUNG HÀM RENDERTABS HOÀN CHỈNH
        function renderTabs() {
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = Object.keys(tabConfig).map(key => `
                <button data-tab="${key}" class="tab-button whitespace-nowrap py-3 px-4 border-b-4 border-transparent font-medium text-sm text-gray-500 hover:text-blue-700">
                    ${tabConfig[key].name}
                </button>
            `).join('');
            tabsContainer.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
            });
        }
        
        // [SỬA LỖI] BỔ SUNG HÀM SETACTIVETAB HOÀN CHỈNH
        function setActiveTab(tabKey) {
            activeTab = tabKey;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.tab === tabKey);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabKey}-content`);
            });
            renderActiveTab();
        }
        
        function renderActiveTab() {
            applySearchFilter();
            const renderFunction = tabConfig[activeTab].renderFunc;
            if (renderFunction) renderFunction();
        }

        function applySearchFilter() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            filteredData = (searchTerm === '') ? allData.hopDong : allData.hopDong.filter(row =>
                Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm))
            );
        }

        // [SỬA LỖI] BỔ SUNG HÀM GETDATERANGE HOÀN CHỈNH
        function getDateRange() {
            return {
                start: startDateInput.value,
                end: endDateInput.value
            };
        }

        // === CÁC HÀM RENDER CHO TỪNG TAB ===

        function renderDashboardTab() {
            const container = document.getElementById('dashboard-content');
            const { start, end } = getDateRange();
            if (!start || !end) {
                container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Vui lòng chọn khoảng thời gian.</div>`;
                return;
            }

            const validStaff = allData.nhanSu.filter(nv =>
                (nv.chức_vụ?.toLowerCase() === 'tpkd' || nv.chức_vụ?.toLowerCase() === 'tvbh') &&
                nv.trạng_thái?.toLowerCase() === 'đang làm việc'
            );
            const carTypes = [...new Set(allData.cacNguon.map(item => item.loại_xe).filter(Boolean))];

            const buildPivotTable = (title, dateFieldKey) => {
                let tableRowsHtml = '';
                let grandTotal = 0;

                validStaff.forEach(staff => {
                    let staffTotal = 0;
                    let staffRowsHtml = '';
                    
                    const staffContracts = filteredData.filter(hd => hd.tvbh === staff.tên_nv);
                    const relevantCarTypesForStaff = carTypes.filter(carType => 
                        staffContracts.some(hd => {
                            const dateValue = hd[dateFieldKey];
                            return hd.loại_xe === carType && dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end;
                        })
                    );

                    if (relevantCarTypesForStaff.length === 0) return;

                    let isFirstRowForStaff = true;
                    relevantCarTypesForStaff.forEach(carType => {
                         const count = staffContracts.filter(hd => {
                            const dateValue = hd[dateFieldKey];
                            return hd.loại_xe === carType && dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end;
                        }).length;

                        if (count > 0) {
                            staffTotal += count;
                            staffRowsHtml += `
                                <tr class="border-b">
                                    ${isFirstRowForStaff ? `<td class="p-3 align-top" rowspan="${relevantCarTypesForStaff.length}">${staff.tên_nv}</td><td class="p-3 align-top" rowspan="${relevantCarTypesForStaff.length}">${staff.team || ''}</td>` : ''}
                                    <td class="p-3">${carType}</td>
                                    <td class="p-3 text-center font-semibold">${count}</td>
                                </tr>
                            `;
                            isFirstRowForStaff = false;
                        }
                    });
                    
                    if(staffTotal > 0) {
                        grandTotal += staffTotal;
                        tableRowsHtml += staffRowsHtml;
                        tableRowsHtml += `<tr class="bg-gray-100 font-bold"><td colspan="3" class="p-3 text-right">Tổng ${staff.tên_nv}:</td><td class="p-3 text-center">${staffTotal}</td></tr>`;
                    }
                });

                return `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <div class="overflow-x-auto table-container">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-200">
                                    <tr class="text-left">
                                        <th class="p-3 w-1/4">TÊN NV</th><th class="p-3 w-1/4">TEAM</th>
                                        <th class="p-3 w-1/4">LOẠI XE</th><th class="p-3 w-1/4 text-center">TỔNG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRowsHtml.length > 0 ? tableRowsHtml : `<tr><td colspan="4" class="text-center p-4">Không có dữ liệu trong khoảng thời gian đã chọn.</td></tr>`}
                                    <tr class="bg-blue-100 text-blue-800 font-extrabold text-base">
                                        <td colspan="3" class="p-3 text-right">TỔNG CỘNG:</td>
                                        <td class="p-3 text-center">${grandTotal}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            };
            container.innerHTML = buildPivotTable('Bảng chỉ tiêu ký', 'tt1') + buildPivotTable('Bảng chỉ tiêu xuất', 'ngày_xhđ');
        }
        
        function renderDonTonTab() {
            const container = document.getElementById('donton-content');
            const data = filteredData.filter(hd => hd.ngày_tt1 && !hd.ngày_xhđ);
            renderDataTable(container, 'Danh sách đơn tồn chưa xuất', data, 
                ['STT', 'TÊN KH', 'TVBH', 'TEAM', 'NGÀY KÝ', 'NGÀY CỌC', 'GHI CHÚ'],
                { 'tên_kh': 'tên_kh', 'tvbh': 'tvbh', 'team': 'team', 'ngày_ký': 'ngày_ký', 'tt1': 'ngày_cọc', 'ghi_chú': 'ghi_chú' }
            );
        }

        // ... Các hàm render khác ...
        function genericRenderWrapper(containerId, title, dateFieldFunc) {
            const container = document.getElementById(containerId);
            const { start, end } = getDateRange();
            if (!start || !end) {
                container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Vui lòng chọn khoảng thời gian.</div>`;
                return;
            }
            const data = filteredData.filter(hd => {
                const dateValue = dateFieldFunc(hd);
                return dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end;
            });
            renderDataTable(container, `Danh sách ${title.toLowerCase()}`, data, ['STT', 'NGÀY KÝ', 'SỐ HĐ', 'TÊN KH', 'TVBH', 'LOẠI XE', 'SỐ KHUNG']);
        }
        
        function renderCongNoTab() { /* ... Logic sẽ được thêm vào ... */ }
        function renderCocTab() { /* ... Logic sẽ được thêm vào ... */ }

        // HÀM RENDER BẢNG CHUNG
        function renderDataTable(container, title, data, headers, mapping) {
             if (!container) return;
             if (data.length === 0) {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md">Không có dữ liệu.</div>`;
                return;
            }

            const headerKeys = headers.map(h => h.toLowerCase().replace(/\s+/g, '_'));
            const dataKeys = mapping ? headers.map(h => Object.keys(mapping).find(key => mapping[key] === h.toLowerCase().replace(/\s+/g, '_'))) : headerKeys;
            
            let tableHtml = `
                <div class="bg-white rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold p-4 border-b">${title} (${data.length})</h3>
                    <div class="overflow-x-auto table-container">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>${headers.map(h => `<th class="p-3">${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${data.map((row, index) => `
                                    <tr data-row-index="${row.rowIndex}" class="border-b clickable-row">
                                        ${headers.map((h, i) => {
                                            let cellValue = '';
                                            if (h === 'STT') {
                                                cellValue = index + 1;
                                            } else {
                                                const key = mapping ? Object.keys(mapping).find(k => mapping[k] === h.toLowerCase().replace(/\s/g, '_')) : h.toLowerCase().replace(/\s/g, '_');
                                                cellValue = formatDate(row[key]);
                                            }
                                            return `<td class="p-3">${cellValue}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            container.innerHTML = tableHtml;
        }

    </script>
</body>
</html>