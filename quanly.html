<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý - Portal VF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .tab-active { border-color: #1d4ed8; color: #1d4ed8; background-color: white; font-weight: 600; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #a8b3c4; }
        .clickable-row:hover { background-color: #eff6ff; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-50">
            </header>

        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Quản Lý Kinh Doanh</h1>
            
            <div id="loading-state" class="flex flex-col items-center justify-center py-20">
                </div>

            <div id="content-wrapper" class="hidden">
                <div class="mb-6 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                            <input type="date" id="start-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                            <input type="date" id="end-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500">
                        </div>
                        <button id="filter-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-filter mr-2"></i>Xem
                        </button>
                    </div>
                     <div class="items-end flex">
                        <div class="w-full">
                             <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm thông minh</label>
                             <div class="relative">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                                 <input type="text" id="search-input" placeholder="Nhập thông tin cần tìm..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                             </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav id="tabs-container" class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs"></nav>
                    </div>
                </div>

                <div id="tab-contents-wrapper">
                    <div id="dashboard-content" class="tab-content space-y-8"></div>
                    <div id="donton-content" class="tab-content"></div>
                    </div>
            </div>
        </main>
    </div>
    
    <script src="config.js"></script>
    <script>
        // === KHAI BÁO BIẾN & DOM ELEMENTS ===
        let allData = { hopDong: [], nhanSu: [], cacNguon: [] };
        let filteredData = []; // Dữ liệu đã được lọc bởi thanh tìm kiếm
        let activeTab = 'dashboard';
        const tabConfig = { /* ... giữ nguyên ... */ };
        // ... các DOM elements khác ...
        const searchInput = document.getElementById('search-input');


        // === UTILITY FUNCTION ===
        function formatDate(isoString) {
            if (!isoString || !String(isoString).includes('T')) return isoString || '';
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN');
            } catch (e) {
                return isoString;
            }
        }

        // === KHỞI TẠO & LẤY DỮ LIỆU ===
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            document.getElementById('filter-btn').addEventListener('click', () => renderActiveTab());
            searchInput.addEventListener('input', () => {
                applySearchFilter();
                renderActiveTab();
            });
        });
        
        function fetchData() {
            // ... (Hàm fetchData không đổi) ...
        }

        function initializeApp() {
             // ... (Hàm initializeApp không đổi) ...
        }

        // === LOGIC TABS, BỘ LỌC, TÌM KIẾM ===
        function renderTabs() { /* ... không đổi ... */ }
        function setActiveTab(tabKey) { /* ... không đổi ... */ }
        
        function renderActiveTab() {
            applySearchFilter();
            const renderFunction = tabConfig[activeTab].renderFunc;
            if (renderFunction) renderFunction();
        }

        function applySearchFilter() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
                filteredData = allData.hopDong;
            } else {
                filteredData = allData.hopDong.filter(row =>
                    Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm))
                );
            }
        }

        function getDateRange() { /* ... không đổi ... */ }

        // === CÁC HÀM RENDER CHO TỪNG TAB (ĐÃ CẬP NHẬT) ===

        function renderDashboardTab() {
            const container = document.getElementById('dashboard-content');
            const { start, end } = getDateRange();

            const validStaff = allData.nhanSu.filter(nv =>
                (nv.chức_vụ?.toLowerCase() === 'tpkd' || nv.chức_vụ?.toLowerCase() === 'tvbh') &&
                nv.trạng_thái?.toLowerCase() === 'đang làm việc'
            );
            const carTypes = [...new Set(allData.cacNguon.map(item => item.loại_xe).filter(Boolean))];

            const buildPivotTable = (title, dateFieldKey) => {
                let tableRowsHtml = '';
                let grandTotal = 0;

                validStaff.forEach(staff => {
                    let staffTotal = 0;
                    let staffRowsHtml = '';
                    let isFirstRowForStaff = true;

                    carTypes.forEach(carType => {
                        const count = allData.hopDong.filter(hd => {
                            const dateValue = hd[dateFieldKey];
                            return hd.tvbh === staff.tên_nv &&
                                   hd.loại_xe === carType &&
                                   dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end;
                        }).length;

                        if (count > 0) {
                            staffTotal += count;
                            staffRowsHtml += `
                                <tr class="border-b">
                                    ${isFirstRowForStaff ? `<td class="p-3 align-top" rowspan="${carTypes.filter(ct => allData.hopDong.some(hd => hd.tvbh === staff.tên_nv && hd.loại_xe === ct && hd[dateFieldKey] && hd[dateFieldKey].split('T')[0] >= start && hd[dateFieldKey].split('T')[0] <= end)).length}">${staff.tên_nv}</td><td class="p-3 align-top" rowspan="${carTypes.filter(ct => allData.hopDong.some(hd => hd.tvbh === staff.tên_nv && hd.loại_xe === ct && hd[dateFieldKey] && hd[dateFieldKey].split('T')[0] >= start && hd[dateFieldKey].split('T')[0] <= end)).length}">${staff.team || ''}</td>` : ''}
                                    <td class="p-3">${carType}</td>
                                    <td class="p-3 text-center font-semibold">${count}</td>
                                </tr>
                            `;
                            isFirstRowForStaff = false;
                        }
                    });
                    
                    if(staffTotal > 0) {
                        grandTotal += staffTotal;
                        tableRowsHtml += staffRowsHtml;
                        tableRowsHtml += `<tr class="bg-gray-100 font-bold"><td colspan="3" class="p-3 text-right">Tổng ${staff.tên_nv}:</td><td class="p-3 text-center">${staffTotal}</td></tr>`;
                    }
                });

                return `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <div class="overflow-x-auto table-container">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-200">
                                    <tr class="text-left">
                                        <th class="p-3 w-1/4">TÊN NV</th>
                                        <th class="p-3 w-1/4">TEAM</th>
                                        <th class="p-3 w-1/4">LOẠI XE</th>
                                        <th class="p-3 w-1/4 text-center">TỔNG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRowsHtml}
                                    <tr class="bg-blue-100 text-blue-800 font-extrabold text-base">
                                        <td colspan="3" class="p-3 text-right">TỔNG CỘNG:</td>
                                        <td class="p-3 text-center">${grandTotal}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            };

            container.innerHTML = buildPivotTable('Bảng chỉ tiêu ký', 'tt1') + buildPivotTable('Bảng chỉ tiêu xuất', 'ngày_xhđ');
        }
        
        function renderDonTonTab() {
            const container = document.getElementById('donton-content');
            const data = filteredData.filter(hd => hd.ngày_tt1 && !hd.ngày_xhđ);

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md">Không có dữ liệu.</div>`;
                return;
            }

            const tableHtml = `
                <div class="bg-white rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold p-4 border-b">Danh sách đơn tồn chưa xuất (${data.length})</h3>
                    <div class="overflow-x-auto table-container">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>
                                    <th class="p-3">STT</th>
                                    <th class="p-3">TÊN KH</th>
                                    <th class="p-3">TVBH</th>
                                    <th class="p-3">TEAM</th>
                                    <th class="p-3">NGÀY KÝ</th>
                                    <th class="p-3">NGÀY CỌC</th>
                                    <th class="p-3">GHI CHÚ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map((row, index) => `
                                    <tr data-row-index="${row.rowIndex}" class="border-b clickable-row">
                                        <td class="p-3">${index + 1}</td>
                                        <td class="p-3">${row.tên_kh || ''}</td>
                                        <td class="p-3">${row.tvbh || ''}</td>
                                        <td class="p-3">${row.team || ''}</td>
                                        <td class="p-3">${formatDate(row.ngày_ký)}</td>
                                        <td class="p-3">${formatDate(row.tt1)}</td>
                                        <td class="p-3">${row.ghi_chú || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            container.innerHTML = tableHtml;
        }

        // ... Các hàm render khác có thể được cập nhật tương tự ...

    </script>
</body>
</html>