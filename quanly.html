<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý - Portal VF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .loader { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #1d4ed8; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #a8b3c4; border-radius: 4px; }
        .clickable-row:hover { background-color: #eff6ff; cursor: pointer; }
        body.modal-is-open { overflow: hidden; }
        /* Tab Styles */
        .tab-link { transition: all 0.2s ease-in-out; }
        .tab-active { border-color: #2563eb; color: #2563eb; background-color: #dbeafe; }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <a href="homepage.html" class="text-2xl font-bold text-blue-700">Portal VF</a>
                <div class="flex items-center">
                    <div id="user-profile" class="flex items-center space-x-3">
                         <span id="user-fullname" class="text-gray-800 font-semibold hidden md:block"></span>
                         <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500">
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="loading-state" class="flex flex-col items-center justify-center py-20">
                <div class="loader"></div>
                <p class="mt-4 text-lg font-medium text-gray-600">Đang tải dữ liệu...</p>
            </div>

            <div id="content-wrapper" class="hidden">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Báo Cáo & Quản Lý</h1>
                
                <div class="mb-6 p-4 bg-white rounded-lg shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                            <input type="date" id="start-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                            <input type="date" id="end-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <button id="filter-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Xem Báo Cáo</button>
                    </div>
                </div>
                
                <div class="mb-4 border-b border-gray-200">
                    <nav id="tabs-container" class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                        <a href="#" data-tab="dashboard" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</a>
                        <a href="#" data-tab="chitieuky" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Chỉ Tiêu Ký</a>
                        <a href="#" data-tab="chitieuxuat" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Chỉ Tiêu Xuất</a>
                        <a href="#" data-tab="donton" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Đơn Tồn</a>
                        <a href="#" data-tab="ky" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">HĐ Đã Ký</a>
                        <a href="#" data-tab="xuat" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">HĐ Đã Xuất</a>
                        <a href="#" data-tab="congno" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Công Nợ</a>
                        <a href="#" data-tab="theodoicoc" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Theo Dõi COC</a>
                        <a href="#" data-tab="dagiao" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Đã Giao Xe</a>
                    </nav>
                </div>

                <div id="tabs-content">
                    <div id="tab-dashboard" class="tab-content p-4"><p>Khu vực dashboard đang được xây dựng.</p></div>
                    <div id="tab-chitieuky" class="tab-content table-container"></div>
                    <div id="tab-chitieuxuat" class="tab-content table-container"></div>
                    <div id="tab-donton" class="tab-content table-container"></div>
                    <div id="tab-ky" class="tab-content table-container"></div>
                    <div id="tab-xuat" class="tab-content table-container"></div>
                    <div id="tab-congno" class="tab-content table-container"></div>
                    <div id="tab-theodoicoc" class="tab-content table-container"></div>
                    <div id="tab-dagiao" class="tab-content table-container"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script>
        // === BIẾN TOÀN CỤC & DOM ELEMENTS ===
        const loadingState = document.getElementById('loading-state');
        const contentWrapper = document.getElementById('content-wrapper');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const filterBtn = document.getElementById('filter-btn');
        
        let allData = { contracts: [], employees: [], carTypes: [] };

        // === KHỞI TẠO TRANG ===
        document.addEventListener('DOMContentLoaded', () => {
            if (!sessionStorage.getItem('loggedInUser')) { window.location.href = 'index.html'; return; }
            if (typeof QUAN_LY_APPS_SCRIPT_URL === 'undefined') { showError('Lỗi cấu hình: QUAN_LY_APPS_SCRIPT_URL not found.'); return; }
            
            // Set ngày mặc định là ngày hiện tại
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            endDateInput.value = today;

            filterBtn.addEventListener('click', renderAllTabs);
            setupTabs();
            fetchInitialData();
        });
        
        function showError(message) {
            loadingState.innerHTML = `<p class="text-red-500 font-bold">${message}</p>`;
        }
        
        // === LẤY DỮ LIỆU ===
        function fetchInitialData() {
            try {
                window.handleDashboardResponse = (result) => {
                    if (result.status === 'ERROR') { throw new Error(result.message); }
                    allData = result.data;
                    loadingState.style.display = 'none';
                    contentWrapper.classList.remove('hidden');
                    renderAllTabs(); // Render lần đầu với ngày mặc định
                };
                const script = document.createElement('script');
                script.src = `${QUAN_LY_APPS_SCRIPT_URL}?action=getDashboardData&callback=handleDashboardResponse`;
                script.onerror = () => { throw new Error('Không thể tải script từ Google.'); };
                script.onload = () => { delete window.handleDashboardResponse; document.body.removeChild(script); };
                document.body.appendChild(script);
            } catch (error) {
                showError(`Lỗi tải dữ liệu: ${error.message}`);
            }
        }

        // === LOGIC TABS ===
        function setupTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Mặc định active tab đầu tiên
            tabLinks[0].classList.add('tab-active');
            tabContents[0].classList.add('tab-content-active');

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;

                    tabLinks.forEach(l => l.classList.remove('tab-active'));
                    link.classList.add('tab-active');

                    tabContents.forEach(content => {
                        content.classList.remove('tab-content-active');
                        if (content.id === `tab-${tabId}`) {
                            content.classList.add('tab-content-active');
                        }
                    });
                });
            });
        }

        // === CÁC HÀM RENDER ===
        function renderAllTabs() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate) {
                alert("Vui lòng chọn đủ ngày bắt đầu và kết thúc.");
                return;
            }

            renderChiTieuTables(startDate, endDate);
            renderDonTonTable();
            renderFilteredTable('ky', 'tt1', startDate, endDate);
            renderFilteredTable('xuat', 'ngày_xhđ', startDate, endDate);
            renderCongNoTable(startDate, endDate);
            renderTheoDoiCocTable(startDate, endDate);
            renderFilteredTable('dagiao', 'ngày_giao_xe', startDate, endDate);
        }

        // --- Render Bảng chỉ tiêu (Phức tạp nhất) ---
        function renderChiTieuTables(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            endDate.setHours(23, 59, 59, 999);

            const filteredContracts = allData.contracts.filter(c => {
                const contractDateKy = c.tt1 ? new Date(c.ngày_tt1 || c.ngày_ký) : null;
                const contractDateXuat = c.ngày_xhđ ? new Date(c.ngày_xhđ) : null;
                return (contractDateKy && contractDateKy >= startDate && contractDateKy <= endDate) || 
                       (contractDateXuat && contractDateXuat >= startDate && contractDateXuat <= endDate);
            });

            // Hàm tính toán chung
            const calculateTotals = (fieldToCheck) => {
                return allData.employees.map(emp => {
                    const carTotals = allData.carTypes.reduce((acc, carType) => {
                        const count = filteredContracts.filter(c => {
                            const contractDate = new Date(c[fieldToCheck === 'tt1' ? 'ngày_tt1' : 'ngày_xhđ']);
                            return c.tvbh === emp.ten_nv && 
                                   c.loại_xe === carType && 
                                   c[fieldToCheck] &&
                                   contractDate >= startDate && contractDate <= endDate;
                        }).length;
                        acc[carType] = count;
                        return acc;
                    }, {});
                    const total = Object.values(carTotals).reduce((sum, count) => sum + count, 0);
                    return { ...emp, carTotals, total };
                });
            };
            
            const kyData = calculateTotals('tt1');
            const xuatData = calculateTotals('ngày_xhđ');

            // Hàm tạo HTML bảng
            const createTableHTML = (title, data) => {
                let html = `<h2 class="text-xl font-bold p-4">${title}</h2><table class="w-full text-sm">`;
                html += `<thead class="bg-gray-100 text-xs uppercase"><tr>
                         <th class="px-4 py-2 text-left">Tên NV</th>
                         <th class="px-4 py-2 text-left">Team</th>`;
                allData.carTypes.forEach(car => html += `<th class="px-4 py-2">${car}</th>`);
                html += `<th class="px-4 py-2 bg-blue-100">Tổng</th></tr></thead><tbody>`;

                data.forEach(row => {
                    html += `<tr class="border-b">
                             <td class="px-4 py-2 font-medium">${row.ten_nv}</td>
                             <td class="px-4 py-2">${row.team}</td>`;
                    allData.carTypes.forEach(car => html += `<td class="px-4 py-2 text-center">${row.carTotals[car] || 0}</td>`);
                    html += `<td class="px-4 py-2 text-center font-bold bg-blue-50">${row.total}</td></tr>`;
                });
                html += `</tbody></table>`;
                return html;
            };

            document.getElementById('tab-chitieuky').innerHTML = createTableHTML('Bảng Chỉ Tiêu Ký', kyData);
            document.getElementById('tab-chitieuxuat').innerHTML = createTableHTML('Bảng Chỉ Tiêu Xuất', xuatData);
        }
        
        // --- Render Đơn tồn (Không cần ngày) ---
        function renderDonTonTable() {
            const filtered = allData.contracts.filter(c => c.ngày_tt1 && !c.ngày_xhđ);
            document.getElementById('tab-donton').innerHTML = createGenericTable(filtered);
        }

        // --- Render Công nợ ---
        function renderCongNoTable(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            endDate.setHours(23, 59, 59, 999);
            
            const filtered = allData.contracts.filter(c => {
                const cocDate = c.ngày_có_coc ? new Date(c.ngày_có_coc) : null;
                if (!cocDate || cocDate < startDate || cocDate > endDate) return false;

                const giaChot = parseFloat(c.giá_chốt || 0);
                const tt1 = parseFloat(c.tt1 || 0);
                const tt2 = parseFloat(c.tt2 || 0);
                const tt3 = parseFloat(c.tt3 || 0);
                const giaiNgan = parseFloat(c.giải_ngân || 0);
                
                return giaChot - (tt1 + tt2 + tt3 + giaiNgan) !== 0;
            });
            document.getElementById('tab-congno').innerHTML = createGenericTable(filtered);
        }
        
        // --- Render Theo dõi COC ---
        function renderTheoDoiCocTable(start, end) {
             const startDate = new Date(start);
             const endDate = new Date(end);
             endDate.setHours(23, 59, 59, 999);
             
             const filtered = allData.contracts.filter(c => {
                 const deNghiDate = c.ngày_đề_nghị_coc ? new Date(c.ngày_đề_nghị_coc) : null;
                 return deNghiDate && deNghiDate >= startDate && deNghiDate <= endDate && !c.ngày_có_coc;
             });
             document.getElementById('tab-theodoicoc').innerHTML = createGenericTable(filtered);
        }

        // --- Hàm render chung cho các tab đơn giản ---
        function renderFilteredTable(tabId, dateField, start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            endDate.setHours(23, 59, 59, 999);
            
            const filtered = allData.contracts.filter(c => {
                const contractDate = c[dateField] ? new Date(c[dateField]) : null;
                return contractDate && contractDate >= startDate && contractDate <= endDate;
            });
            document.getElementById(`tab-${tabId}`).innerHTML = createGenericTable(filtered);
        }

        // === HÀM TRỢ GIÚP TẠO BẢNG HTML ===
        function createGenericTable(data) {
             if (!data || data.length === 0) return '<p class="p-4 text-center text-gray-500">Không có dữ liệu phù hợp.</p>';
            let html = '<table class="w-full text-sm"><thead><tr class="bg-gray-100 text-xs uppercase">';
            // Lấy header từ file HTML (hoặc có thể định nghĩa cứng ở đây)
            html += `<th class="px-4 py-2 text-left">Ngày Ký</th>
                     <th class="px-4 py-2 text-left">Số HĐ</th>
                     <th class="px-4 py-2 text-left">Tên KH</th>
                     <th class="px-4 py-2 text-left">Loại Xe</th>
                     <th class="px-4 py-2 text-left">Số Khung</th>
                     <th class="px-4 py-2 text-left">TVBH</th>
                     <th class="px-4 py-2 text-left">Ngày Giao Xe</th>
                     </tr></thead><tbody>`;
            data.forEach(row => {
                 html += `<tr class="border-b clickable-row" data-row-index="${row.rowIndex}">
                     <td class="px-4 py-2">${row.ngày_ký ? new Date(row.ngày_ký).toLocaleDateString('vi-VN') : ''}</td>
                     <td class="px-4 py-2 font-medium">${row.shđ || ''}</td>
                     <td class="px-4 py-2">${row.tên_kh || ''}</td>
                     <td class="px-4 py-2">${row.loại_xe || ''}</td>
                     <td class="px-4 py-2">${row.số_khung || ''}</td>
                     <td class="px-4 py-2">${row.tvbh || ''}</td>
                     <td class="px-4 py-2">${row.ngày_giao_xe ? new Date(row.ngày_giao_xe).toLocaleDateString('vi-VN') : ''}</td>
                 </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

    </script>
</body>
</html>