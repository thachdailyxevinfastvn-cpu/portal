<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý - Portal VF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .tab-active { border-color: #1d4ed8; color: #1d4ed8; background-color: white; font-weight: 600; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #a8b3c4; }
        .clickable-row:hover { background-color: #eff6ff; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        body.modal-is-open { overflow: hidden; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .button-loading { cursor: not-allowed; opacity: 0.8; }

        /* === NEW STYLES FOR VIEW/EDIT MODE === */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.25rem; font-weight: 500; color: #374151; }
        .data-view {
            padding: 0.5rem 0.75rem;
            min-height: 38px; /* Match input height */
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            word-wrap: break-word;
        }
        .data-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
        }
        /* Hide inputs in view mode, hide spans in edit mode */
        .view-mode .data-input { display: none; }
        .edit-mode .data-view { display: none; }
        .view-mode .data-input { visibility: hidden; }
        .edit-mode .data-view { visibility: hidden; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-50"></header>

        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Quản Lý Kinh Doanh</h1>
            
            <div id="loading-state" class="flex flex-col items-center justify-center py-20">
                <div class="loader" style="border: 4px solid #e5e7eb; border-left-color: #1d4ed8; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite;"></div>
                <p class="mt-4 text-lg">Đang tải dữ liệu...</p>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            </div>

            <div id="content-wrapper" class="hidden">
                 <div class="mb-6 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label>
                            <input type="date" id="start-date" class="w-full border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label>
                            <input type="date" id="end-date" class="w-full border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <button id="filter-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Xem</button>
                    </div>
                     <div class="items-end flex">
                        <div class="w-full">
                             <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm thông minh</label>
                             <div class="relative">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                                 <input type="text" id="search-input" placeholder="Nhập thông tin cần tìm..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg">
                             </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6"><div class="border-b border-gray-200"><nav id="tabs-container" class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto"></nav></div></div>

                <div id="tab-contents-wrapper">
                    <div id="dashboard-content" class="tab-content space-y-8"></div>
                    <div id="donton-content" class="tab-content"></div>
                    <div id="ky-content" class="tab-content"></div>
                    <div id="xuat-content" class="tab-content"></div>
                    <div id="congno-content" class="tab-content"></div>
                    <div id="coc-content" class="tab-content"></div>
                    <div id="dagiao-content" class="tab-content"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="detail-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" id="modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 sm:mx-auto sm:w-full sm:max-w-6xl transform scale-95 relative transition-transform duration-300" id="modal-content">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Chi Tiết Hợp Đồng</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-form-container" class="p-6 max-h-[80vh] overflow-y-auto space-y-4 text-sm">
                <input type="hidden" id="edit-row-index">

                <details class="bg-gray-50 rounded-lg" open>
                    <summary class="p-3 font-semibold flex justify-between items-center">Nhân viên phụ trách <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Tên TVBH</label><span class="data-view" data-view-field="tvbh"></span><input type="text" class="data-input" data-field="tvbh"></div>
                        <div class="form-group"><label>Team</label><span class="data-view" data-view-field="team"></span><input type="text" class="data-input" data-field="team"></div>
                    </div>
                </details>

                <details class="bg-gray-50 rounded-lg" open>
                    <summary class="p-3 font-semibold flex justify-between items-center">Thông tin Khách hàng <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Tên KH</label><span class="data-view" data-view-field="tên_kh"></span><input type="text" class="data-input" data-field="tên_kh"></div>
                        <div class="form-group"><label>SĐT</label><span class="data-view" data-view-field="sđt"></span><input type="text" class="data-input" data-field="sđt"></div>
                        <div class="form-group"><label>Email</label><span class="data-view" data-view-field="email"></span><input type="email" class="data-input" data-field="email"></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label>Địa chỉ</label><span class="data-view" data-view-field="địa_chỉ"></span><input type="text" class="data-input" data-field="địa_chỉ"></div>
                    </div>
                </details>

                <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Thông tin Hợp đồng <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Số HĐ</label><span class="data-view" data-view-field="shđ"></span><input type="text" class="data-input" data-field="shđ"></div>
                        <div class="form-group"><label>Ngày ký</label><span class="data-view" data-view-field="ngày_ký"></span><input type="date" class="data-input" data-field="ngày_ký"></div>
                    </div>
                </details>

                <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Thanh toán <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Hình thức TT</label><span class="data-view" data-view-field="hình_thức_thanh_toán"></span><input type="text" class="data-input" data-field="hình_thức_thanh_toán"></div>
                        <div class="form-group"><label>Ngân hàng</label><span class="data-view" data-view-field="ngân_hàng"></span><input type="text" class="data-input" data-field="ngân_hàng"></div>
                        <div class="form-group"><label>TT1 (Cọc)</label><span class="data-view" data-view-field="tt1"></span><input type="text" class="data-input" data-field="tt1"></div>
                        <div class="form-group"><label>Ngày TT1</label><span class="data-view" data-view-field="ngày_tt1"></span><input type="date" class="data-input" data-field="ngày_tt1"></div>
                        <div class="form-group"><label>TT2</label><span class="data-view" data-view-field="tt2"></span><input type="text" class="data-input" data-field="tt2"></div>
                        <div class="form-group"><label>Ngày TT2</label><span class="data-view" data-view-field="ngày_tt2"></span><input type="date" class="data-input" data-field="ngày_tt2"></div>
                        <div class="form-group"><label>TT3</label><span class="data-view" data-view-field="tt3"></span><input type="text" class="data-input" data-field="tt3"></div>
                        <div class="form-group"><label>Ngày TT3</label><span class="data-view" data-view-field="ngày_tt3"></span><input type="date" class="data-input" data-field="ngày_tt3"></div>
                        <div class="form-group"><label>Giải ngân</label><span class="data-view" data-view-field="giải_ngân"></span><input type="text" class="data-input" data-field="giải_ngân"></div>
                        <div class="form-group"><label>Ngày GN</label><span class="data-view" data-view-field="ngày_gn"></span><input type="date" class="data-input" data-field="ngày_gn"></div>
                    </div>
                </details>

                <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Công nợ <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Giá công bố</label><span class="data-view" data-view-field="giá_công_bố"></span><input type="text" class="data-input" data-field="giá_công_bố"></div>
                        <div class="form-group"><label>Giá XHĐ</label><span class="data-view" data-view-field="giá_xhđ"></span><input type="text" class="data-input" data-field="giá_xhđ"></div>
                        <div class="form-group"><label>Ra lộc</label><span class="data-view" data-view-field="ra_lộc"></span><input type="text" class="data-input" data-field="ra_lộc"></div>
                        <div class="form-group"><label>Giá chốt</label><span class="data-view" data-view-field="giá_chốt"></span><input type="text" class="data-input" data-field="giá_chốt"></div>
                        <div class="form-group"><label>Lợi nhuận</label><span class="data-view" data-view-field="lợi_nhuận"></span><input type="text" class="data-input" data-field="lợi_nhuận"></div>
                        <div class="form-group">
                            <label>Công nợ</label>
                            <span class="data-view font-bold text-red-600" id="calculated-cong-no"></span>
                            </div>
                    </div>
                </details>
                <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Thông tin Xe <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                         <div class="form-group"><label>Loại xe</label><span class="data-view" data-view-field="loại_xe"></span><input type="text" class="data-input" data-field="loại_xe"></div>
                        <div class="form-group"><label>Phiên bản</label><span class="data-view" data-view-field="phiên_bản"></span><input type="text" class="data-input" data-field="phiên_bản"></div>
                        <div class="form-group"><label>Số khung</label><span class="data-view" data-view-field="số_khung"></span><input type="text" class="data-input" data-field="số_khung"></div>
                        <div class="form-group"><label>Số máy</label><span class="data-view" data-view-field="số_máy"></span><input type="text" class="data-input" data-field="số_máy"></div>
                        <div class="form-group"><label>Ngoại thất</label><span class="data-view" data-view-field="ngoại_thất"></span><input type="text" class="data-input" data-field="ngoại_thất"></div>
                        <div class="form-group"><label>Nội thất TV</label><span class="data-view" data-view-field="nội_thất_tv"></span><input type="text" class="data-input" data-field="nội_thất_tv"></div>
                        <div class="form-group"><label>Mã nội thất</label><span class="data-view" data-view-field="mã_nội_thất"></span><input type="text" class="data-input" data-field="mã_nội_thất"></div>
                        <div class="form-group"><label>Kho DMS</label><span class="data-view" data-view-field="kho_dms"></span><input type="text" class="data-input" data-field="kho_dms"></div>
                        <div class="form-group"><label>Kho vật lý</label><span class="data-view" data-view-field="kho_vật_lý"></span><input type="text" class="data-input" data-field="kho_vật_lý"></div>
                        <div class="form-group"><label>PO</label><span class="data-view" data-view-field="po"></span><input type="text" class="data-input" data-field="po"></div>
                    </div>
                </details>

                <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Chính sách <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>CS Nội bộ</label><span class="data-view" data-view-field="cs_nội_bộ"></span><input type="text" class="data-input" data-field="cs_nội_bộ"></div>
                        <div class="form-group"><label>Hoa hồng Sale</label><span class="data-view" data-view-field="hoa_hồng_sale"></span><input type="text" class="data-input" data-field="hoa_hồng_sale"></div>
                        <div class="form-group"><label>HH GDKD</label><span class="data-view" data-view-field="hh_gdkd"></span><input type="text" class="data-input" data-field="hh_gdkd"></div>
                        <div class="form-group"><label>HH TPKD</label><span class="data-view" data-view-field="hh_tpkd"></span><input type="text" class="data-input" data-field="hh_tpkd"></div>
                        <div class="form-group"><label>CTKM</label><span class="data-view" data-view-field="ctkm"></span><input type="text" class="data-input" data-field="ctkm"></div>
                    </div>
                </details>

                 <details class="bg-gray-50 rounded-lg">
                    <summary class="p-3 font-semibold flex justify-between items-center">Vận hành <i class="fas fa-chevron-down"></i></summary>
                    <div class="p-4 border-t data-grid">
                        <div class="form-group"><label>Ngày đề nghị COC</label><span class="data-view" data-view-field="ngày_đề_nghị_coc"></span><input type="date" class="data-input" data-field="ngày_đề_nghị_coc"></div>
                        <div class="form-group"><label>Ngày có COC</label><span class="data-view" data-view-field="ngày_có_coc"></span><input type="date" class="data-input" data-field="ngày_có_coc"></div>
                        <div class="form-group"><label>Ngày đăng ký xe</label><span class="data-view" data-view-field="ngày_đăng_ký_xe"></span><input type="date" class="data-input" data-field="ngày_đăng_ký_xe"></div>
                        <div class="form-group"><label>Ngày giao xe</label><span class="data-view" data-view-field="ngày_giao_xe"></span><input type="date" class="data-input" data-field="ngày_giao_xe"></div>
                    </div>
                </details>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3">
                <button id="edit-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-green-700">Chỉnh sửa</button>
                <button id="cancel-edit-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-600 hidden">Hủy bỏ</button>
                <button id="submit-update-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 hidden">Lưu thay đổi</button>
                <button id="close-modal-footer-btn" class="bg-white border border-gray-300 py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-50">Đóng</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

    <script src="config.js"></script>
    <script>
        // === KHAI BÁO BIẾN & DOM ELEMENTS ===
        let allData = { hopDong: [], nhanSu: [], cacNguon: [] };
        let filteredData = [];
        let activeTab = 'dashboard';

        const tabConfig = {
            'dashboard': { name: 'Dashboard', renderFunc: renderDashboardTab },
            'donton': { name: 'Đơn tồn chưa xuất', renderFunc: renderDonTonTab },
            'ky': { name: 'Ký', renderFunc: renderKyTab },
            'xuat': { name: 'Xuất', renderFunc: renderXuatTab },
            'congno': { name: 'Công nợ', renderFunc: renderCongNoTab },
            'coc': { name: 'Theo dõi COC', renderFunc: renderCocTab },
            'dagiao': { name: 'Đã giao', renderFunc: renderDaGiaoTab },
        };
        
        const HEADER_ALIASES = { 'ngày_tt1': 'NGÀY CỌC', 'tt1': 'SỐ TIỀN CỌC', 'team': 'PKD' };

        const loadingState = document.getElementById('loading-state');
        const contentWrapper = document.getElementById('content-wrapper');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const searchInput = document.getElementById('search-input');
        const detailModal = document.getElementById('detail-modal');
        const modalContent = document.getElementById('modal-content');
        const tabContentsWrapper = document.getElementById('tab-contents-wrapper');

        // === UTILITY FUNCTIONS ===
        function formatDate(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) { return isoString; }
        }
        function formatCurrency(value) {
            const number = Number(value);
            if (isNaN(number) || value === null || value === '') return '';
            return new Intl.NumberFormat('vi-VN').format(number);
        }
        
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
        };


        // === MODAL LOGIC ===
        function openModal() { detailModal.classList.remove('hidden'); document.body.classList.add('modal-is-open'); }
        function closeModal() { detailModal.classList.add('hidden'); document.body.classList.remove('modal-is-open'); }
        
        function setModalMode(mode) { // 'view' or 'edit'
            const isEditMode = mode === 'edit';
            modalContent.classList.toggle('view-mode', !isEditMode);
            modalContent.classList.toggle('edit-mode', isEditMode);

            document.getElementById('edit-btn').style.display = isEditMode ? 'none' : 'inline-block';
            document.getElementById('close-modal-footer-btn').style.display = isEditMode ? 'none' : 'inline-block';
            
            document.getElementById('cancel-edit-btn').style.display = isEditMode ? 'inline-block' : 'none';
            document.getElementById('submit-update-btn').style.display = isEditMode ? 'inline-block' : 'none';
        }
        
        function calculateCongNo(rowData) {
            const giaChot = parseFloat(rowData.giá_chốt) || 0;
            const tt1 = parseFloat(rowData.tt1) || 0;
            const tt2 = parseFloat(rowData.tt2) || 0;
            const tt3 = parseFloat(rowData.tt3) || 0;
            const giaiNgan = parseFloat(rowData.giải_ngân) || 0;
            return giaChot - (tt1 + tt2 + tt3 + giaiNgan);
        }

        function openDetailModal(rowIndex) {
            const rowData = allData.hopDong.find(row => row.rowIndex === rowIndex);
            if (!rowData) { 
                showToast('Không tìm thấy dữ liệu chi tiết.', false);
                return;
            }
            document.getElementById('edit-row-index').value = rowIndex;
            
            document.querySelectorAll('#modal-form-container [data-field]').forEach(input => {
                const fieldName = input.dataset.field;
                const viewElement = document.querySelector(`[data-view-field="${fieldName}"]`);
                let value = rowData[fieldName] || '';
                let displayValue = value;

                if (input.type === 'date') {
                    if (value) value = new Date(value).toISOString().split('T')[0];
                    displayValue = formatDate(value);
                } else if (['tt1', 'tt2', 'tt3', 'giải_ngân', 'giá_chốt', 'giá_công_bố', 'giá_xhđ', 'ra_lộc', 'lợi_nhuận'].includes(fieldName)) {
                    displayValue = formatCurrency(value);
                }

                input.value = value;
                if (viewElement) {
                    viewElement.textContent = displayValue;
                }
            });
            
            // Calculate and display Công nợ
            const congNo = calculateCongNo(rowData);
            document.getElementById('calculated-cong-no').textContent = formatCurrency(congNo);


            setModalMode('view');
            openModal();
        }

        async function handleUpdateData() {
            const submitBtn = document.getElementById('submit-update-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span><i class="fas fa-spinner fa-spin"></i> Đang lưu...</span>`;
            
            const payloadData = {
                rowIndex: parseInt(document.getElementById('edit-row-index').value),
                updatedData: {},
            };
            document.querySelectorAll('#modal-form-container [data-field]').forEach(input => {
                payloadData.updatedData[input.dataset.field] = input.value;
            });
            try {
                const response = await fetch(QUAN_LY_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'updateManagementData', data: payloadData })
                });
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                
                showToast('Cập nhật thành công!', true);
                closeModal();
                fetchData(); 
            } catch (error) {
                showToast(`Lỗi cập nhật: ${error.message}`, false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Lưu thay đổi';
            }
        }

        // === KHỞI TẠO & LẤY DỮ LIỆU ===
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            document.getElementById('filter-btn').addEventListener('click', () => renderActiveTab());
            searchInput.addEventListener('input', () => {
                applySearchFilter();
                renderActiveTab();
            });
            // Modal event listeners
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('modal-overlay').addEventListener('click', closeModal);
            document.getElementById('close-modal-footer-btn').addEventListener('click', closeModal);
            document.getElementById('submit-update-btn').addEventListener('click', handleUpdateData);

            document.getElementById('edit-btn').addEventListener('click', () => {
                if (confirm('Bạn có chắc chắn muốn chỉnh sửa hợp đồng này không?')) {
                    setModalMode('edit');
                }
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                setModalMode('view');
            });

            tabContentsWrapper.addEventListener('click', (event) => {
                const row = event.target.closest('.clickable-row');
                if (row) {
                    const rowIndex = parseInt(row.dataset.rowIndex);
                    if (rowIndex) {
                        openDetailModal(rowIndex);
                    }
                }
            });
        });
        
        function fetchData() {
            loadingState.style.display = 'flex';
            contentWrapper.classList.add('hidden');
            try {
                window.handleDashboardResponse = (result) => {
                    if (result.status === 'ERROR') { throw new Error(result.message); }
                    allData = result.data;
                    initializeApp();
                };
                const script = document.createElement('script');
                const cacheBuster = new Date().getTime();
                script.src = `${QUAN_LY_APPS_SCRIPT_URL}?action=getDashboardData&callback=handleDashboardResponse&v=${cacheBuster}`;
                script.onerror = () => { alert('Không thể tải dữ liệu từ Google Apps Script.'); };
                script.onload = () => { 
                    document.body.removeChild(script); 
                    delete window.handleDashboardResponse; 
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error(error);
                alert(`Đã xảy ra lỗi: ${error.message}`);
            }
        }

        function initializeApp() {
            loadingState.style.display = 'none';
            contentWrapper.classList.remove('hidden');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = firstDayOfMonth;
            renderTabs();
            setActiveTab('dashboard');
        }

        // === LOGIC TABS, BỘ LỌC, TÌM KIẾM ===
        function renderTabs() {
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = Object.keys(tabConfig).map(key => `<button data-tab="${key}" class="tab-button whitespace-nowrap py-3 px-4 border-b-4 border-transparent font-medium text-sm text-gray-500 hover:text-blue-700">${tabConfig[key].name}</button>`).join('');
            tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
        }
        
        function setActiveTab(tabKey) {
            activeTab = tabKey;
            searchInput.value = '';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('tab-active', btn.dataset.tab === tabKey));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `${tabKey}-content`));
            renderActiveTab();
        }
        
        function renderActiveTab() {
            applySearchFilter();
            const renderFunction = tabConfig[activeTab].renderFunc;
            if (renderFunction) renderFunction();
        }

        function applySearchFilter() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            filteredData = (searchTerm === '') ? allData.hopDong : allData.hopDong.filter(row => Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm)));
        }

        function getDateRange() { return { start: startDateInput.value, end: endDateInput.value }; }

        // === CÁC HÀM RENDER CHO TỪNG TAB (No change from original) ===
        function renderDashboardTab() {
            const container = document.getElementById('dashboard-content');
            const { start, end } = getDateRange();
            if (!start || !end) {
                container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Vui lòng chọn khoảng thời gian.</div>`;
                return;
            }
            const validStaff = allData.nhanSu.filter(nv => nv.trạng_thái?.toLowerCase() === 'đang làm việc');
            const carTypes = [...new Set(allData.cacNguon.map(item => item.loại_xe).filter(Boolean))];
            const buildPivotTable = (title, dateFieldKey) => {
                let tableRowsHtml = '';
                let grandTotal = 0;
                validStaff.forEach(staff => {
                    const staffContracts = filteredData.filter(hd => hd.tvbh === staff.tên_nv);
                    if (staffContracts.length === 0) return;
                    
                    const relevantData = staffContracts.filter(hd => {
                        const dateValue = hd[dateFieldKey];
                        return dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end;
                    });
                    if (relevantData.length === 0) return;

                    const relevantCarTypesForStaff = [...new Set(relevantData.map(hd => hd.loại_xe))];

                    let staffTotal = 0;
                    let isFirstRowForStaff = true;
                    let staffRowsHtmlChunk = '';
                    
                    relevantCarTypesForStaff.forEach(carType => {
                         const count = relevantData.filter(hd => hd.loại_xe === carType).length;
                        if (count > 0) {
                            staffTotal += count;
                            staffRowsHtmlChunk += `<tr class="border-b">${isFirstRowForStaff ? `<td class="p-3 align-top" rowspan="${relevantCarTypesForStaff.length}">${staff.tên_nv}</td><td class="p-3 align-top" rowspan="${relevantCarTypesForStaff.length}">${staff.pkd || ''}</td>` : ''}<td class="p-3">${carType}</td><td class="p-3 text-center font-semibold">${count}</td></tr>`;
                            isFirstRowForStaff = false;
                        }
                    });

                    if(staffTotal > 0) {
                        grandTotal += staffTotal;
                        tableRowsHtml += staffRowsHtmlChunk;
                        tableRowsHtml += `<tr class="bg-gray-100 font-bold"><td colspan="3" class="p-3 text-right">Tổng ${staff.tên_nv}:</td><td class="p-3 text-center">${staffTotal}</td></tr>`;
                    }
                });
                return `<div class="bg-white p-4 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">${title}</h3><div class="overflow-x-auto table-container"><table class="w-full text-sm"><thead class="bg-gray-200"><tr class="text-left"><th class="p-3 w-1/4">TÊN NV</th><th class="p-3 w-1/4">TEAM</th><th class="p-3 w-1/4">LOẠI XE</th><th class="p-3 w-1/4 text-center">TỔNG</th></tr></thead><tbody>${tableRowsHtml.length > 0 ? tableRowsHtml : `<tr><td colspan="4" class="text-center p-4">Không có dữ liệu.</td></tr>`}<tr class="bg-blue-100 text-blue-800 font-extrabold text-base"><td colspan="3" class="p-3 text-right">TỔNG CỘNG:</td><td class="p-3 text-center">${grandTotal}</td></tr></tbody></table></div></div>`;
            };
            container.innerHTML = buildPivotTable('Bảng chỉ tiêu ký', 'ngày_tt1') + buildPivotTable('Bảng chỉ tiêu xuất', 'ngày_xhđ');
        }
        
        // === START: CẬP NHẬT RENDERDONTONTAB ===
        function renderDonTonTab() {
            const data = filteredData
                .filter(hd => hd.ngày_tt1 && !hd.ngày_xhđ)
                .map(hd => ({ ...hd, công_nợ: calculateCongNo(hd) })); // Thêm công nợ vào data
            
            const headers = ['STT', 'TÊN KH', 'TVBH', 'PKD', 'NGÀY KÝ', 'NGÀY CỌC', 'CÔNG NỢ', 'GHI CHÚ'];
            const keys = ['stt', 'tên_kh', 'tvbh', 'team', 'ngày_ký', 'ngày_tt1', 'công_nợ', 'ghi_chú'];
            renderDataTable(document.getElementById('donton-content'), 'Danh sách đơn tồn chưa xuất', data, headers, keys);
        }
        // === END: CẬP NHẬT RENDERDONTONTAB ===

        function renderKyTab() {
            const { start, end } = getDateRange();
            const data = filteredData.filter(hd => {
                const ngayKy = hd.ngày_tt1;
                return ngayKy && ngayKy.split('T')[0] >= start && ngayKy.split('T')[0] <= end;
            });
            const headers = ['STT', 'NGÀY CỌC', 'SỐ HĐ', 'TÊN KH', 'TVBH', 'LOẠI XE', 'SỐ TIỀN CỌC'];
            const keys = ['stt', 'ngày_tt1', 'shđ', 'tên_kh', 'tvbh', 'loại_xe', 'tt1'];
            renderDataTable(document.getElementById('ky-content'), `Danh sách ký hợp đồng`, data, headers, keys);
        }
        function renderXuatTab() {
            const { start, end } = getDateRange();
            const data = filteredData.filter(hd => hd.ngày_xhđ && hd.ngày_xhđ.split('T')[0] >= start && hd.ngày_xhđ.split('T')[0] <= end);
            const headers = ['STT', 'NGÀY XHĐ', 'SỐ HĐ', 'TÊN KH', 'TVBH', 'LOẠI XE', 'SỐ KHUNG'];
            const keys = ['stt', 'ngày_xhđ', 'shđ', 'tên_kh', 'tvbh', 'loại_xe', 'số_khung'];
            renderDataTable(document.getElementById('xuat-content'), `Danh sách xuất HĐ`, data, headers, keys);
        }
        function renderCongNoTab() {
            const { start, end } = getDateRange();
            const data = filteredData.map(hd => {
                const daThanhToan = (parseFloat(hd.tt1) || 0) + (parseFloat(hd.tt2) || 0) + (parseFloat(hd.tt3) || 0) + (parseFloat(hd.giải_ngân) || 0);
                return { ...hd, công_nợ: (parseFloat(hd.giá_chốt) || 0) - daThanhToan, đã_thanh_toán: daThanhToan };
            }).filter(hd => {
                const ngayKy = hd.ngày_tt1;
                return ngayKy && ngayKy.split('T')[0] >= start && ngayKy.split('T')[0] <= end && hd.công_nợ !== 0;
            });
            const headers = ['STT', 'TÊN KH', 'TVBH', 'GIÁ CHỐT', 'ĐÃ TT', 'CÔNG NỢ'];
            const keys = ['stt', 'tên_kh', 'tvbh', 'giá_chốt', 'đã_thanh_toán', 'công_nợ'];
            renderDataTable(document.getElementById('congno-content'), `Danh sách công nợ`, data, headers, keys);
        }
        function renderCocTab() {
             const { start, end } = getDateRange();
             const data = filteredData.filter(hd => 
                hd.ngày_đề_nghị_coc && hd.ngày_đề_nghị_coc.split('T')[0] >= start && hd.ngày_đề_nghị_coc.split('T')[0] <= end && !hd.ngày_có_coc
            );
            const headers = ['STT', 'NGÀY ĐỀ NGHỊ', 'TÊN KH', 'TVBH', 'LOẠI XE', 'GHI CHÚ'];
            const keys = ['stt', 'ngày_đề_nghị_coc', 'tên_kh', 'tvbh', 'loại_xe', 'ghi_chú'];
            renderDataTable(document.getElementById('coc-content'), `Theo dõi COC`, data, headers, keys);
        }
        function renderDaGiaoTab() {
            const { start, end } = getDateRange();
            const data = filteredData.filter(hd => hd.ngày_giao_xe && hd.ngày_giao_xe.split('T')[0] >= start && hd.ngày_giao_xe.split('T')[0] <= end);
            const headers = ['STT', 'NGÀY GIAO XE', 'TÊN KH', 'TVBH', 'LOẠI XE', 'SỐ KHUNG'];
            const keys = ['stt', 'ngày_giao_xe', 'tên_kh', 'tvbh', 'loại_xe', 'số_khung'];
            renderDataTable(document.getElementById('dagiao-content'), `Danh sách đã giao xe`, data, headers, keys);
        }

        // === HÀM RENDER BẢNG CHUNG TỐI ƯU ===
        function renderDataTable(container, title, data, headers, keys) {
             if (!container) return;
             if (data.length === 0) {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md">Không có dữ liệu.</div>`;
                return;
            }
            let tableHtml = `<div class="bg-white rounded-lg shadow-md"><h3 class="text-lg font-semibold p-4 border-b">${title} (${data.length})</h3><div class="overflow-x-auto table-container"><table class="w-full text-sm">`;
            tableHtml += `<thead class="bg-gray-50 text-left"><tr>${headers.map(h => `<th class="p-3">${h}</th>`).join('')}</tr></thead>`;
            tableHtml += `<tbody>${data.map((row, index) => {
                const cells = keys.map(key => {
                    let cellValue;
                    if (key === 'stt') { cellValue = index + 1; } 
                    else {
                        const originalKey = Object.keys(HEADER_ALIASES).find(k => HEADER_ALIASES[k] === key.toUpperCase()) || key;
                        cellValue = row[originalKey];
                        if (originalKey.includes('ngày') || HEADER_ALIASES[originalKey]?.includes('NGÀY')) {
                            cellValue = formatDate(cellValue);
                        } else if (['tt1', 'giá_chốt', 'công_nợ', 'đã_thanh_toán'].includes(originalKey)) {
                            cellValue = formatCurrency(cellValue);
                        }
                    }
                    return `<td class="p-3">${cellValue || ''}</td>`;
                }).join('');
                return `<tr data-row-index="${row.rowIndex}" class="border-b clickable-row">${cells}</tr>`;
            }).join('')}</tbody>`;
            tableHtml += `</table></div></div>`;
            container.innerHTML = tableHtml;
        }

    </script>
</body>
</html>