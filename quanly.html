<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý - Portal VF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .tab-active { border-color: #1d4ed8; color: #1d4ed8; background-color: white; font-weight: 600; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #a8b3c4; }
        .clickable-row:hover { background-color: #eff6ff; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        body.modal-is-open { overflow: hidden; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .button-loading { cursor: not-allowed; opacity: 0.8; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.25rem; font-weight: 500; color: #374151; }
        .data-view, .data-input {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
        .data-view { min-height: 38px; background-color: #f9fafb; word-wrap: break-word; }
        .view-mode .data-input, .edit-mode .data-view { display: none; visibility: hidden; }

        .dashboard-table, .data-table { border-collapse: collapse; font-size: 0.8rem; width: 100%; }
        .dashboard-table th, .dashboard-table td,
        .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 4px 8px; }
        .sortable { cursor: pointer; position: relative; }
        .sortable:hover { background-color: #eef2ff; }
        .sortable.sorted-asc, .sortable.sorted-desc {
             color: #1d4ed8;
             font-weight: 600;
        }
        .dashboard-table thead th, .data-table thead th {
            position: sticky;
            top: 0;
            background-color: #e5e7eb;
            z-index: 10;
        }
        .dashboard-table .car-type-header { white-space: normal; word-break: break-word; vertical-align: middle; text-align: center; }

        #modal-content, #add-modal-content { 
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        #modal-form-container, #add-modal-form-container { 
            flex-grow: 1;
            overflow-y: auto;
        }

        .fit-content-column {
            white-space: nowrap; 
        }
        /* [CHỈNH SỬA] CSS cho cột Ghi chú */
        .ghi-chu-column {
            min-width: 300px; /* Đặt chiều rộng tối thiểu */
            white-space: nowrap; /* Ngăn không cho xuống dòng */
            overflow: hidden;
            text-overflow: ellipsis; /* Hiển thị ... nếu quá dài */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Quản Lý Kinh Doanh</h1>
            <div id="loading-state" class="flex flex-col items-center justify-center py-20">
                <div class="loader" style="border: 4px solid #e5e7eb; border-left-color: #1d4ed8; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite;"></div>
                <p class="mt-4 text-lg">Đang tải dữ liệu...</p>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            </div>
            <div id="content-wrapper" class="hidden">
                 <div class="mb-6 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> 
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div><label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Từ ngày</label><input type="date" id="start-date" class="w-full border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Đến ngày</label><input type="date" id="end-date" class="w-full border-gray-300 rounded-lg shadow-sm"></div>
                        <button id="filter-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Xem</button>
                    </div>
                     <div class="items-end flex"><div class="w-full"><label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm thông minh</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div><input type="text" id="search-input" placeholder="Nhập thông tin cần tìm..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg"></div></div></div>
                     <div class="items-end flex">
                        <button id="open-add-modal-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                            <i class="fas fa-user-plus"></i>
                            <span>Nhập khách hàng</span>
                        </button>
                    </div>
                </div>
                <div class="mb-6"><div class="border-b border-gray-200"><nav id="tabs-container" class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto"></nav></div></div>
                <div id="tab-contents-wrapper"><div id="dashboard-content" class="tab-content space-y-8"></div><div id="donton-content" class="tab-content"></div><div id="ky-content" class="tab-content"></div><div id="xuat-content" class="tab-content"></div><div id="congno-content" class="tab-content"></div><div id="coc-content" class="tab-content"></div><div id="dagiao-content" class="tab-content"></div><div id="hoancoc-content" class="tab-content"></div></div>
            </div>
        </main>
    </div>
    
    <div id="add-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" id="add-modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 sm:mx-auto sm:w-full sm:max-w-4xl transform scale-95 relative transition-transform duration-300" id="add-modal-content">
            <div class="px-6 py-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-medium text-gray-900">Nhập Hợp Đồng Khách Hàng Mới</h3>
                <button id="close-add-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="add-modal-form-container" class="p-6 space-y-4 text-sm">
                <form id="add-contract-form">
                    <details class="bg-blue-50 border border-blue-200 rounded-lg" open>
                        <summary class="p-3 font-semibold text-blue-800 flex justify-between items-center">Điền thông minh <i class="fas fa-wand-magic-sparkles"></i></summary>
                        <div class="p-4 border-t space-y-2">
                            <textarea id="smart-fill-input" rows="8" class="w-full border-gray-300 rounded-md" placeholder="Dán nội dung báo cáo ký hợp đồng vào đây..."></textarea>
                            <button id="smart-fill-btn" type="button" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-700"><i class="fas fa-cogs"></i> Xử lý dữ liệu</button>
                        </div>
                    </details>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="form-group"><label>TVBH</label><select id="add-tvbh" class="data-input"></select></div>
                        <div class="form-group"><label>PKD</label><input type="text" id="add-pkd" class="data-input bg-gray-100" readonly></div>
                        <div class="form-group"><label>Loại xe</label><select id="add-loai-xe" class="data-input"></select></div>
                        <div class="form-group"><label>Tên KH</label><input type="text" id="add-ten-kh" class="data-input"></div>
                        <div class="form-group col-span-2"><label>Địa chỉ</label><input type="text" id="add-dia-chi" class="data-input"></div>
                        <div class="form-group"><label>SĐT</label><input type="text" id="add-sdt" class="data-input"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="add-email" class="data-input"></div>
                        <div class="form-group"><label>CCCD</label><input type="text" id="add-cccd" class="data-input"></div>
                        <div class="form-group"><label>Ngày cấp CCCD</label><input type="date" id="add-ngay-cap-cccd" class="data-input"></div>
                        <div class="form-group"><label>TT1 (Cọc)</label><input type="text" id="add-tt1" class="data-input currency-input"></div>
                        <div class="form-group"><label>Ngày TT1 (Ngày cọc)</label><input type="date" id="add-ngay-tt1" class="data-input"></div>
                        <div class="form-group"><label>Giá XHĐ</label><input type="text" id="add-gia-xhd" class="data-input currency-input"></div>
                        <div class="form-group"><label>Ra lộc</label><input type="text" id="add-ra-loc" class="data-input currency-input"></div>
                    </div>
                </form> </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t flex-shrink-0">
                <button id="close-add-modal-footer-btn" class="bg-white border border-gray-300 py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-50">Hủy</button>
                <button id="submit-add-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-green-700">Lưu Hợp Đồng</button>
            </div>
        </div>
    </div>


    <div id="detail-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" id="modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 sm:mx-auto sm:w-full sm:max-w-6xl transform scale-95 relative transition-transform duration-300" id="modal-content">
            <div class="px-6 py-4 border-b flex justify-between items-center flex-shrink-0"><h3 class="text-lg font-medium text-gray-900">Chi Tiết Hợp Đồng</h3><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button></div>
            <div id="modal-form-container" class="p-6 space-y-4 text-sm">
                <input type="hidden" id="edit-row-index">
                <details class="bg-gray-50 rounded-lg" open><summary class="p-3 font-semibold flex justify-between items-center">Nhân viên phụ trách <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>Tên TVBH</label><span class="data-view" data-view-field="tvbh"></span><input type="text" class="data-input" data-field="tvbh"></div><div class="form-group"><label>Team</label><span class="data-view" data-view-field="team"></span><input type="text" class="data-input" data-field="team"></div></div></details>
                <details class="bg-gray-50 rounded-lg" open><summary class="p-3 font-semibold flex justify-between items-center">Thông tin Khách hàng <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>Tên KH</label><span class="data-view" data-view-field="tên_kh"></span><input type="text" class="data-input" data-field="tên_kh"></div><div class="form-group"><label>SĐT</label><span class="data-view" data-view-field="sđt"></span><input type="text" class="data-input" data-field="sđt"></div><div class="form-group"><label>Email</label><span class="data-view" data-view-field="email"></span><input type="email" class="data-input" data-field="email"></div><div class="form-group" style="grid-column: 1 / -1;"><label>Địa chỉ</label><span class="data-view" data-view-field="địa_chỉ"></span><input type="text" class="data-input" data-field="địa_chỉ"></div></div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Thông tin Hợp đồng <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>Số HĐ</label><span class="data-view" data-view-field="shđ"></span><input type="text" class="data-input" data-field="shđ"></div><div class="form-group"><label>Ngày ký</label><span class="data-view" data-view-field="ngày_ký"></span><input type="date" class="data-input" data-field="ngày_ký"></div><div class="form-group"><label>Ngày hoàn cọc</label><span class="data-view" data-view-field="ngày_hoàn_cọc"></span><input type="date" class="data-input" data-field="ngày_hoàn_cọc"></div></div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Thanh toán <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid">
                    <div class="form-group"><label>Hình thức TT</label><span class="data-view" data-view-field="hình_thức_thanh_toán"></span><input type="text" class="data-input" data-field="hình_thức_thanh_toán"></div>
                    <div class="form-group"><label>Ngân hàng</label><span class="data-view" data-view-field="ngân_hàng"></span><input type="text" class="data-input" data-field="ngân_hàng"></div>
                    <div class="form-group"><label>TT1 (Cọc)</label><span class="data-view" data-view-field="tt1"></span><input type="text" class="data-input currency-input" data-field="tt1"></div>
                    <div class="form-group"><label>Ngày TT1</label><span class="data-view" data-view-field="ngày_tt1"></span><input type="date" class="data-input" data-field="ngày_tt1"></div>
                    <div class="form-group"><label>TT2</label><span class="data-view" data-view-field="tt2"></span><input type="text" class="data-input currency-input" data-field="tt2"></div>
                    <div class="form-group"><label>Ngày TT2</label><span class="data-view" data-view-field="ngày_tt2"></span><input type="date" class="data-input" data-field="ngày_tt2"></div>
                    <div class="form-group"><label>TT3</label><span class="data-view" data-view-field="tt3"></span><input type="text" class="data-input currency-input" data-field="tt3"></div>
                    <div class="form-group"><label>Ngày TT3</label><span class="data-view" data-view-field="ngày_tt3"></span><input type="date" class="data-input" data-field="ngày_tt3"></div>
                    <div class="form-group"><label>Giải ngân</label><span class="data-view" data-view-field="giải_ngân"></span><input type="text" class="data-input currency-input" data-field="giải_ngân"></div>
                    <div class="form-group"><label>Ngày GN</label><span class="data-view" data-view-field="ngày_gn"></span><input type="date" class="data-input" data-field="ngày_gn"></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Đã thanh toán</label><span class="data-view calculated-da-thanh-toan font-bold text-blue-700"></span></div>
                </div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Công nợ <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid">
                    <div class="form-group"><label>Giá công bố</label><span class="data-view" data-view-field="giá_công_bố"></span><input type="text" class="data-input currency-input" data-field="giá_công_bố"></div>
                    <div class="form-group"><label>Giá XHĐ</label><span class="data-view" data-view-field="giá_xhđ"></span><input type="text" class="data-input currency-input" data-field="giá_xhđ"></div>
                    <div class="form-group"><label>Ra lộc</label><span class="data-view" data-view-field="ra_lộc"></span><input type="text" class="data-input currency-input" data-field="ra_lộc"></div>
                    <div class="form-group"><label>Giá chốt</label><span class="data-view" data-view-field="giá_chốt"></span><input type="text" class="data-input currency-input" data-field="giá_chốt"></div>
                    <div class="form-group"><label>Lợi nhuận</label><span class="data-view" data-view-field="lợi_nhuận"></span><input type="text" class="data-input currency-input" data-field="lợi_nhuận"></div>
                    <div class="form-group"><label>Đã thanh toán</label><span class="data-view calculated-da-thanh-toan font-bold text-blue-700"></span></div>
                    <div class="form-group"><label>Công nợ</label><span class="data-view font-bold text-red-600" id="calculated-cong-no"></span></div>
                </div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Thông tin Xe <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>Loại xe</label><span class="data-view" data-view-field="loại_xe"></span><input type="text" class="data-input" data-field="loại_xe"></div><div class="form-group"><label>Phiên bản</label><span class="data-view" data-view-field="phiên_bản"></span><input type="text" class="data-input" data-field="phiên_bản"></div><div class="form-group"><label>Mã ngoại thất</label><span class="data-view" data-view-field="mã_ngoại_thất"></span><input type="text" class="data-input" data-field="mã_ngoại_thất"></div><div class="form-group"><label>Ngoại thất TV</label><span class="data-view" data-view-field="ngoại_thất_tv"></span><input type="text" class="data-input" data-field="ngoại_thất_tv"></div><div class="form-group"><label>Mã nội thất</label><span class="data-view" data-view-field="mã_nội_thất"></span><input type="text" class="data-input" data-field="mã_nội_thất"></div><div class="form-group"><label>Nội thất TV</label><span class="data-view" data-view-field="nội_thất_tv"></span><input type="text" class="data-input" data-field="nội_thất_tv"></div><div class="form-group"><label>Số khung</label><span class="data-view" data-view-field="số_khung"></span><input type="text" class="data-input" data-field="số_khung"></div><div class="form-group"><label>Số máy</label><span class="data-view" data-view-field="số_máy"></span><input type="text" class="data-input" data-field="số_máy"></div><div class="form-group"><label>Kho DMS</label><span class="data-view" data-view-field="kho_dms"></span><input type="text" class="data-input" data-field="kho_dms"></div><div class="form-group"><label>Kho vật lý</label><span class="data-view" data-view-field="kho_vật_lý"></span><input type="text" class="data-input" data-field="kho_vật_lý"></div><div class="form-group"><label>PO</label><span class="data-view" data-view-field="po"></span><input type="text" class="data-input" data-field="po"></div></div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Chính sách <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>CS Nội bộ</label><span class="data-view" data-view-field="cs_nội_bộ"></span><input type="text" class="data-input" data-field="cs_nội_bộ"></div><div class="form-group"><label>Hoa hồng Sale</label><span class="data-view" data-view-field="hoa_hồng_sale"></span><input type="text" class="data-input" data-field="hoa_hồng_sale"></div><div class="form-group"><label>HH GDKD</label><span class="data-view" data-view-field="hh_gdkd"></span><input type="text" class="data-input" data-field="hh_gdkd"></div><div class="form-group"><label>HH TPKD</label><span class="data-view" data-view-field="hh_tpkd"></span><input type="text" class="data-input" data-field="hh_tpkd"></div><div class="form-group"><label>CTKM</label><span class="data-view" data-view-field="ctkm"></span><input type="text" class="data-input" data-field="ctkm"></div></div></details>
                <details class="bg-gray-50 rounded-lg"><summary class="p-3 font-semibold flex justify-between items-center">Vận hành <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t data-grid"><div class="form-group"><label>Ngày đề nghị COC</label><span class="data-view" data-view-field="ngày_đề_nghị_coc"></span><input type="date" class="data-input" data-field="ngày_đề_nghị_coc"></div><div class="form-group"><label>Ngày có COC</label><span class="data-view" data-view-field="ngày_có_coc"></span><input type="date" class="data-input" data-field="ngày_có_coc"></div><div class="form-group"><label>Ngày đăng ký xe</label><span class="data-view" data-view-field="ngày_đăng_ký_xe"></span><input type="date" class="data-input" data-field="ngày_đăng_ký_xe"></div><div class="form-group"><label>Ngày giao xe</label><span class="data-view" data-view-field="ngày_giao_xe"></span><input type="date" class="data-input" data-field="ngày_giao_xe"></div></div></details>
                <details class="bg-gray-50 rounded-lg" open><summary class="p-3 font-semibold flex justify-between items-center">Lịch sử Ghi chú <i class="fas fa-chevron-down"></i></summary><div class="p-4 border-t space-y-3"><div class="form-group edit-mode"><label for="modal-new-note">Thêm ghi chú mới</label><textarea id="modal-new-note" rows="3" class="w-full border-gray-300 rounded-md data-input" placeholder="Nhập ghi chú mới..."></textarea></div><div class="form-group"><label>Lịch sử</label><div id="modal-notes-timeline" class="p-2 bg-white border rounded-md max-h-60 overflow-y-auto space-y-2"></div></div></div></details>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t flex-shrink-0"><button id="edit-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-green-700">Chỉnh sửa</button><button id="cancel-edit-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-600 hidden">Hủy bỏ</button><button id="submit-update-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 hidden">Lưu thay đổi</button><button id="close-modal-footer-btn" class="bg-white border border-gray-300 py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-50">Đóng</button></div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

    <script src="config.js"></script>
    <script>
        let allData = { hopDong: [], nhanSu: [], cacNguon: [] };
        let filteredData = [];
        let activeTab = 'dashboard';
        let sortStates = {};

        const tabConfig = { 'dashboard': { name: 'Dashboard', renderFunc: renderDashboardTab },'donton': { name: 'Đơn tồn chưa xuất', renderFunc: renderDonTonTab }, 'ky': { name: 'Ký', renderFunc: renderKyTab }, 'xuat': { name: 'Xuất', renderFunc: renderXuatTab }, 'congno': { name: 'Công nợ COC', renderFunc: renderCongNoCocTab }, 'coc': { name: 'Theo dõi COC', renderFunc: renderCocTab }, 'dagiao': { name: 'Đã giao', renderFunc: renderDaGiaoTab }, 'hoancoc': { name: 'Hoàn cọc', renderFunc: renderHoanCocTab }, };
        const loadingState = document.getElementById('loading-state');
        const contentWrapper = document.getElementById('content-wrapper');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const searchInput = document.getElementById('search-input');
        const detailModal = document.getElementById('detail-modal');
        const modalContent = document.getElementById('modal-content');
        const tabContentsWrapper = document.getElementById('tab-contents-wrapper');
        
        const addModal = document.getElementById('add-modal');

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                let date;
                if (String(dateString).includes('T')) {
                    date = new Date(dateString);
                } else if (String(dateString).includes('/')) {
                    const parts = dateString.split('/');
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                     date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) return dateString;
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateString;
            }
        }

        function formatCurrency(value) { const number = Number(String(value).replace(/\./g, '')); if (isNaN(number) || value === null || value === '') return ''; return new Intl.NumberFormat('vi-VN').format(number); }
        function showToast(message, isSuccess = true) { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`; toast.classList.remove('opacity-0'); setTimeout(() => { toast.classList.add('opacity-0'); }, 3000); };

        function openModal(modalEl) { modalEl.classList.remove('hidden'); document.body.classList.add('modal-is-open'); } 
        function closeModal(modalEl) { modalEl.classList.add('hidden'); document.body.classList.remove('modal-is-open'); } 
        
        function setModalMode(mode) {
            const isEditMode = mode === 'edit';
            modalContent.classList.toggle('view-mode', !isEditMode);
            modalContent.classList.toggle('edit-mode', isEditMode);
            document.getElementById('edit-btn').style.display = isEditMode ? 'none' : 'inline-block';
            document.getElementById('close-modal-footer-btn').style.display = isEditMode ? 'none' : 'inline-block';
            document.getElementById('cancel-edit-btn').style.display = isEditMode ? 'inline-block' : 'none';
            document.getElementById('submit-update-btn').style.display = isEditMode ? 'inline-block' : 'none';
        }
        
        function updateCalculatedFields() {
            const getNumericValue = (field) => parseFloat(document.querySelector(`[data-field="${field}"]`).value.replace(/\./g, '')) || 0;
            const tt1 = getNumericValue('tt1');
            const tt2 = getNumericValue('tt2');
            const tt3 = getNumericValue('tt3');
            const giaiNgan = getNumericValue('giải_ngân');
            const giaChot = getNumericValue('giá_chốt');
            
            const daThanhToan = tt1 + tt2 + tt3 + giaiNgan;
            const congNo = giaChot - daThanhToan;
            
            document.querySelectorAll('.calculated-da-thanh-toan').forEach(el => el.textContent = formatCurrency(daThanhToan));
            document.getElementById('calculated-cong-no').textContent = formatCurrency(congNo);
        }

        function openDetailModal(rowIndex) {
            const rowData = allData.hopDong.find(row => row.rowIndex === rowIndex);
            if (!rowData) { showToast('Không tìm thấy dữ liệu chi tiết.', false); return; }
            document.getElementById('edit-row-index').value = rowIndex;
            
            document.querySelectorAll('#modal-form-container [data-field]').forEach(input => {
                const fieldName = input.dataset.field;
                const viewElement = document.querySelector(`[data-view-field="${fieldName}"]`);
                let value = rowData[fieldName] || '';
                let displayValue = value;

                if (input.classList.contains('currency-input')) {
                    displayValue = formatCurrency(value);
                    input.value = displayValue;
                } else if (input.type === 'date') { 
                    if (value) {
                       const parts = String(value).split('/');
                       if (parts.length === 3) {
                           value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                       } else {
                           value = new Date(value).toISOString().split('T')[0];
                       }
                    } 
                    displayValue = formatDate(rowData[fieldName]);
                    input.value = value;
                } else {
                    input.value = value;
                }
                if (viewElement) viewElement.textContent = displayValue;
            });
            
            const notesTimeline = document.getElementById('modal-notes-timeline');
            notesTimeline.innerHTML = '';
            const fullNotes = rowData.ghi_chú || '';
            if (fullNotes.trim()) {
                fullNotes.split('--------------------').filter(n => n.trim()).forEach(noteText => {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'p-2 border-b last:border-b-0';
                    noteElement.style.whiteSpace = 'pre-wrap';
                    noteElement.textContent = noteText.trim();
                    notesTimeline.appendChild(noteElement);
                });
            } else { notesTimeline.textContent = 'Chưa có ghi chú.'; }
            document.getElementById('modal-new-note').value = '';
            
            updateCalculatedFields();
            setModalMode('view');
            openModal(detailModal); 
        }
        
        function populateAddModalDropdowns() {
            const tvbhSelect = document.getElementById('add-tvbh');
            const loaiXeSelect = document.getElementById('add-loai-xe');
            
            tvbhSelect.innerHTML = '<option value="">-- Chọn TVBH/TPKD --</option>';
            const tvbhList = allData.nhanSu.filter(nv => 
                (nv.chức_vụ === 'TVBH' || nv.chức_vụ === 'TPKD') && nv.trạng_thái === 'Đang làm việc'
            );
            tvbhList.forEach(nv => {
                const option = document.createElement('option');
                option.value = nv.tên_nv;
                option.textContent = nv.tên_nv;
                option.dataset.pkd = nv.pkd || '';
                tvbhSelect.appendChild(option);
            });

            loaiXeSelect.innerHTML = '<option value="">-- Chọn Loại Xe --</option>';
            const carTypes = [...new Set(allData.cacNguon.map(item => item.loại_xe).filter(Boolean))];
            carTypes.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.textContent = car;
                loaiXeSelect.appendChild(option);
            });
        }
        
        function handleSmartFill() {
            const text = document.getElementById('smart-fill-input').value;
            if (!text.trim()) {
                showToast('Vui lòng nhập nội dung để xử lý.', false);
                return;
            }

            const extractValue = (regex) => {
                const match = text.match(regex);
                return match && match[1] ? match[1].trim() : '';
            };
            
            const parseDate = (dateString) => {
                const match = dateString.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                if (match) {
                    const [_, day, month, year] = match;
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                return '';
            };

            const fields = {
                tvbh: extractValue(/(?:TVBH|Tư vấn bán hàng)\s*:\s*(.*)/i),
                ten_kh: extractValue(/(?:Khách hàng|TÊN KH|Tên khách hàng)\s*:\s*(.*)/i),
                cccd: extractValue(/(?:CCCD|Căn cước công dân)\s*:\s*([\d]+)/i),
                ngay_cap_cccd: parseDate(extractValue(/(?:Ngày cấp|NGÀY CẤP CCCD)\s*:\s*(.*)/i)),
                dia_chi: extractValue(/(?:Địa chỉ)\s*:\s*(.*)/i),
                loai_xe_text: extractValue(/(?:Loại xe)\s*:\s*(.*)/i),
                tt1: extractValue(/(?:Tiền cọc|Cọc)\s*:\s*([\d.,]+)/i).replace(/\./g, ''),
                gia_xhd: extractValue(/(?:Giá hợp đồng và XHĐ|Giá XHĐ|Giá hợp đồng)\s*:\s*([\d.,]+)/i).replace(/\./g, ''),
                sdt: extractValue(/(?:SĐT|Số điện thoại)\s*:\s*([\d\s.]+)/i).replace(/\s/g, '').replace(/\./g, ''),
                email: extractValue(/(?:SĐT|Email)\s*:\s*([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})/i),
                hinh_thuc_mua: extractValue(/(?:Hình thức mua)\s*:\s*(.*)/i)
            };
            
            document.getElementById('add-ten-kh').value = fields.ten_kh;
            document.getElementById('add-dia-chi').value = fields.dia_chi;
            document.getElementById('add-cccd').value = fields.cccd;
            document.getElementById('add-ngay-cap-cccd').value = fields.ngay_cap_cccd;
            
            document.getElementById('add-tt1').value = formatCurrency(fields.tt1);
            document.getElementById('add-gia-xhd').value = formatCurrency(fields.gia_xhd);
            
            if (fields.email) {
                 document.getElementById('add-email').value = fields.email;
            }
            if (fields.sdt && !fields.sdt.includes('@')) {
                 document.getElementById('add-sdt').value = fields.sdt;
            }

            const tvbhSelect = document.getElementById('add-tvbh');
            for (let option of tvbhSelect.options) {
                if (option.value === fields.tvbh) {
                    option.selected = true;
                    tvbhSelect.dispatchEvent(new Event('change'));
                    break;
                }
            }

            const carModels = ["VF3", "VF5", "VF6", "VF7", "VF8", "VF9", "Minio Green", "EC Van", "Herio Green", "Nerio Green", "Limo Green"];
            const loaiXeSelect = document.getElementById('add-loai-xe');
            const foundCar = carModels.find(model => fields.loai_xe_text.toUpperCase().includes(model.toUpperCase()));
            if (foundCar) {
                 for (let option of loaiXeSelect.options) {
                    if (option.value.toUpperCase().includes(foundCar.toUpperCase())) {
                        option.selected = true;
                        break;
                    }
                }
            }
            showToast('Đã xử lý và điền thông tin!', true);
        }

        async function handleAddContract() {
             const submitBtn = document.getElementById('submit-add-btn');
             submitBtn.disabled = true;
             submitBtn.innerHTML = `<span><i class="fas fa-spinner fa-spin"></i> Đang lưu...</span>`;
            
             const payload = {
                tvbh: document.getElementById('add-tvbh').value,
                pkd: document.getElementById('add-pkd').value,
                tên_kh: document.getElementById('add-ten-kh').value.toUpperCase().trim(),
                địa_chỉ: document.getElementById('add-dia-chi').value,
                sđt: document.getElementById('add-sdt').value,
                email: document.getElementById('add-email').value,
                cccd: document.getElementById('add-cccd').value,
                ngày_cấp_cccd: document.getElementById('add-ngay-cap-cccd').value,
                tt1: document.getElementById('add-tt1').value.replace(/\./g, ''),
                ngày_tt1: document.getElementById('add-ngay-tt1').value,
                loại_xe: document.getElementById('add-loai-xe').value,
                giá_xhđ: document.getElementById('add-gia-xhd').value.replace(/\./g, ''),
                ra_lộc: document.getElementById('add-ra-loc').value.replace(/\./g, ''),
             };
             
             if (!payload.tên_kh || !payload.sđt || !payload.tvbh) {
                 showToast('Vui lòng điền các trường bắt buộc (TVBH, Tên KH, SĐT).', false);
                 submitBtn.disabled = false;
                 submitBtn.innerHTML = 'Lưu Hợp Đồng';
                 return;
             }

             try {
                const response = await fetch(QUAN_LY_APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({ action: 'addContract', data: payload }) 
                });
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                
                showToast('Thêm hợp đồng mới thành công!', true);
                closeModal(addModal);
                fetchData(); 
            } catch (error) {
                showToast(`Lỗi: ${error.message}`, false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Lưu Hợp Đồng';
            }
        }


        async function handleUpdateData() {
            const submitBtn = document.getElementById('submit-update-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span><i class="fas fa-spinner fa-spin"></i> Đang lưu...</span>`;
            
            const rowIndex = parseInt(document.getElementById('edit-row-index').value);
            const payloadData = { rowIndex: rowIndex, updatedData: {} };

            document.querySelectorAll('#modal-form-container [data-field]').forEach(input => {
                 let value = input.value;
                 if (input.classList.contains('currency-input')) {
                    value = value.replace(/\./g, '');
                 }
                 payloadData.updatedData[input.dataset.field] = value;
            });
            
            const newNote = document.getElementById('modal-new-note').value.trim();
            if (newNote) {
                const originalRow = allData.hopDong.find(row => row.rowIndex === rowIndex);
                const oldNotes = (originalRow && originalRow.ghi_chú) ? originalRow.ghi_chú : '';
                const timestamp = new Date().toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                payloadData.updatedData['ghi_chú'] = `[${timestamp}] ${newNote}\n--------------------\n${oldNotes}`;
            }

            try {
                const response = await fetch(QUAN_LY_APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'updateManagementData', data: payloadData }) });
                const result = await response.json();
                if (result.status === 'ERROR') throw new Error(result.message);
                
                showToast('Cập nhật thành công!', true);
                closeModal(detailModal); 
                fetchData(); 
            } catch (error) {
                showToast(`Lỗi cập nhật: ${error.message}`, false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Lưu thay đổi';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            document.getElementById('filter-btn').addEventListener('click', () => renderActiveTab());
            searchInput.addEventListener('input', () => { applySearchFilter(); renderActiveTab(); });
            
            document.getElementById('close-modal-btn').addEventListener('click', () => closeModal(detailModal));
            document.getElementById('modal-overlay').addEventListener('click', () => closeModal(detailModal));
            document.getElementById('close-modal-footer-btn').addEventListener('click', () => closeModal(detailModal));
            document.getElementById('submit-update-btn').addEventListener('click', handleUpdateData);
            document.getElementById('edit-btn').addEventListener('click', () => { if (confirm('Bạn có chắc chắn muốn chỉnh sửa hợp đồng này không?')) { setModalMode('edit'); } });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => { setModalMode('view'); const rowIndex = parseInt(document.getElementById('edit-row-index').value); openDetailModal(rowIndex); });
            
            document.getElementById('open-add-modal-btn').addEventListener('click', () => {
                document.getElementById('add-contract-form').reset(); 
                openModal(addModal);
            });
            document.getElementById('close-add-modal-btn').addEventListener('click', () => closeModal(addModal));
            document.getElementById('add-modal-overlay').addEventListener('click', () => closeModal(addModal));
            document.getElementById('close-add-modal-footer-btn').addEventListener('click', () => closeModal(addModal));
            document.getElementById('add-tvbh').addEventListener('change', (e) => {
                 const selectedOption = e.target.options[e.target.selectedIndex];
                 document.getElementById('add-pkd').value = selectedOption.dataset.pkd || '';
            });
            document.getElementById('smart-fill-btn').addEventListener('click', handleSmartFill);
            document.getElementById('submit-add-btn').addEventListener('click', handleAddContract);
            
            const currencyInputs = document.querySelectorAll('.currency-input');
            currencyInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    e.target.value = value ? formatCurrency(value) : '';
                    if(document.body.classList.contains('modal-is-open') && !addModal.classList.contains('hidden')) {
                       updateCalculatedFields();
                    }
                });
            });

            tabContentsWrapper.addEventListener('dblclick', (event) => { const row = event.target.closest('.clickable-row'); if (row) { const rowIndex = parseInt(row.dataset.rowIndex); if (rowIndex) openDetailModal(rowIndex); } });
            tabContentsWrapper.addEventListener('click', (event) => {
                const sortableHeader = event.target.closest('.sortable');
                if (sortableHeader) {
                    const key = sortableHeader.dataset.sortKey;
                    const tableType = sortableHeader.dataset.tableType;
                    const currentSort = sortStates[tableType] || { key: 'stt', direction: 'asc' };
                    if (currentSort.key === key) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; } else { currentSort.key = key; currentSort.direction = 'asc'; }
                    sortStates[tableType] = currentSort;
                    renderActiveTab();
                }
            });
        });
        
        function fetchData() {
            loadingState.style.display = 'flex';
            contentWrapper.classList.add('hidden');
            try {
                window.handleDashboardResponse = (result) => { if (result.status === 'ERROR') { throw new Error(result.message); } allData = result.data; initializeApp(); };
                const script = document.createElement('script');
                script.src = `${QUAN_LY_APPS_SCRIPT_URL}?action=getDashboardData&callback=handleDashboardResponse&v=${new Date().getTime()}`;
                script.onerror = () => { alert('Không thể tải dữ liệu từ Google Apps Script.'); };
                script.onload = () => { document.body.removeChild(script); delete window.handleDashboardResponse; };
                document.body.appendChild(script);
            } catch (error) { console.error(error); alert(`Đã xảy ra lỗi: ${error.message}`); }
        }

        function initializeApp() {
            loadingState.style.display = 'none';
            contentWrapper.classList.remove('hidden');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const formatDateToYyyyMmDd = (date) => `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            startDateInput.value = formatDateToYyyyMmDd(firstDayOfMonth);
            endDateInput.value = formatDateToYyyyMmDd(lastDayOfMonth);
            sortStates['ky'] = { key: 'stt', direction: 'asc' };
            sortStates['xuat'] = { key: 'stt', direction: 'asc' };
            
            populateAddModalDropdowns(); 
            
            renderTabs();
            setActiveTab('dashboard');
        }

        function renderTabs() { const tabsContainer = document.getElementById('tabs-container'); tabsContainer.innerHTML = Object.keys(tabConfig).map(key => `<button data-tab="${key}" class="tab-button whitespace-nowrap py-3 px-4 border-b-4 border-transparent font-medium text-sm text-gray-500 hover:text-blue-700">${tabConfig[key].name}</button>`).join(''); tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab))); }
        function setActiveTab(tabKey) { activeTab = tabKey; searchInput.value = ''; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('tab-active', btn.dataset.tab === tabKey)); document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `${tabKey}-content`)); renderActiveTab(); }
        function renderActiveTab() { applySearchFilter(); const renderFunction = tabConfig[activeTab].renderFunc; if (renderFunction) renderFunction(); }
        function applySearchFilter() { const searchTerm = searchInput.value.toLowerCase().trim(); filteredData = (searchTerm === '') ? allData.hopDong : allData.hopDong.filter(row => Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm))); }
        function getDateRange() { return { start: startDateInput.value, end: endDateInput.value }; }

        function renderDashboardTab() {
            const container = document.getElementById('dashboard-content');
            const { start, end } = getDateRange();
            if (!start || !end) { container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Vui lòng chọn khoảng thời gian.</div>`; return; }
            const buildPivotTable = (title, dateFieldKey, tableType) => {
                const validStaff = allData.nhanSu.filter(nv => (nv.chức_vụ === 'TPKD' || nv.chức_vụ === 'TVBH') && nv.trạng_thái === 'Đang làm việc').map((staff, index) => ({...staff, originalIndex: index}));
                const carTypes = [...new Set(allData.cacNguon.map(item => item.loại_xe).filter(Boolean))].sort((a, b) => { const aIsVF = a.toUpperCase().startsWith('VF'); const bIsVF = b.toUpperCase().startsWith('VF'); if (aIsVF && !bIsVF) return -1; if (!aIsVF && bIsVF) return 1; return a.localeCompare(b, undefined, {numeric: true}); });
                if (validStaff.length === 0 || carTypes.length === 0) { return `<div class="bg-white p-4 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">${title}</h3><p>Không có dữ liệu.</p></div>`; }
                const dynamicTitle = `${title} Từ ngày ${formatDate(start)} đến ${formatDate(end)}`;
                const relevantContracts = filteredData.filter(hd => { const dateValue = hd[dateFieldKey]; return dateValue && dateValue.split('T')[0] >= start && dateValue.split('T')[0] <= end; });
                let processedData = validStaff.map(staff => { const staffContracts = relevantContracts.filter(hd => hd.tvbh === staff.tên_nv); let rowTotal = 0; const counts = {}; carTypes.forEach(car => { const count = staffContracts.filter(hd => hd.loại_xe === car).length; counts[car] = count; rowTotal += count; }); return { staff, counts, total: rowTotal }; });
                const { key, direction } = sortStates[tableType];
                processedData.sort((a, b) => { let valA, valB; if (key === 'stt') { valA = a.staff.originalIndex; valB = b.staff.originalIndex; } else if (key === 'tên_nv') { valA = a.staff.tên_nv; valB = b.staff.tên_nv; } else if (key === 'team') { valA = a.staff.pkd || ''; valB = b.staff.pkd || ''; } else if (key === 'total') { valA = a.total; valB = b.total; } else { valA = a.counts[key] || 0; valB = b.counts[key] || 0; } const compare = (typeof valA === 'string') ? valA.localeCompare(valB, 'vi') : (valA > valB ? 1 : (valA < valB ? -1 : 0)); return direction === 'asc' ? compare : -compare; });
                const getSortClass = (k) => (key === k ? `sorted-${direction}` : '');
                let headerHtml = `<tr><th class="sortable ${getSortClass('stt')}" data-sort-key="stt" data-table-type="${tableType}" style="width: 45px;">STT</th><th class="sortable ${getSortClass('tên_nv')}" data-sort-key="tên_nv" data-table-type="${tableType}" style="width: 180px;">TÊN NV</th><th class="sortable ${getSortClass('team')}" data-sort-key="team" data-table-type="${tableType}" style="width: 80px;">TEAM</th>`;
                carTypes.forEach(car => headerHtml += `<th class="sortable car-type-header ${getSortClass(car)}" data-sort-key="${car}" data-table-type="${tableType}">${car}</th>`);
                headerHtml += `<th class="sortable ${getSortClass('total')}" data-sort-key="total" data-table-type="${tableType}" style="width: 60px;">TỔNG</th></tr>`;
                let bodyHtml = '';
                const columnTotals = carTypes.reduce((acc, car) => ({...acc, [car]: 0}), {});
                let grandTotal = 0;
                processedData.forEach((item, index) => { bodyHtml += `<tr><td class="text-center">${index + 1}</td><td class="font-medium">${item.staff.tên_nv}</td><td>${item.staff.pkd || ''}</td>`; carTypes.forEach(car => { const count = item.counts[car] || 0; bodyHtml += `<td class="text-center">${count > 0 ? count : ''}</td>`; columnTotals[car] += count; }); bodyHtml += `<td class="text-center font-bold bg-gray-50">${item.total}</td></tr>`; grandTotal += item.total; });
                let footerHtml = `<tr><td class="font-extrabold" colspan="3">TỔNG CỘNG</td>`;
                carTypes.forEach(car => footerHtml += `<td class="text-center font-extrabold">${columnTotals[car]}</td>`);
                footerHtml += `<td class="text-center font-extrabold">${grandTotal}</td></tr>`;
                return `<div class="bg-white p-4 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">${dynamicTitle}</h3><div class="overflow-x-auto table-container" style="max-height: 600px;"><table class="w-full text-sm dashboard-table" style="table-layout: fixed; width: 100%;"><thead>${headerHtml}</thead><tbody class="bg-white">${bodyHtml}</tbody><tfoot class="bg-blue-100 text-blue-800">${footerHtml}</tfoot></table></div></div>`;
            };
            container.innerHTML = buildPivotTable('Bảng kết quả ký', 'ngày_tt1', 'ky') + buildPivotTable('Bảng kết quả xuất', 'ngày_xhđ', 'xuat');
        }
        function renderDonTonTab() { const data = filteredData.filter(hd => hd.ngày_tt1 && !hd.ngày_xhđ && !hd.ngày_hoàn_cọc); const headers = ['STT', 'TÊN KH', 'TVBH', 'PKD', 'LOẠI XE', 'NGÀY CỌC', 'SỐ TIỀN CỌC', 'GHI CHÚ']; const keys = ['stt', 'tên_kh', 'tvbh', 'team', 'loại_xe', 'ngày_tt1', 'tt1', 'ghi_chú']; renderDataTable(document.getElementById('donton-content'), 'Danh sách đơn tồn chưa xuất', data, headers, keys, 'donton'); }
        function renderKyTab() { const { start, end } = getDateRange(); const data = filteredData.filter(hd => { const ngayKy = hd.ngày_tt1; return ngayKy && ngayKy.split('T')[0] >= start && ngayKy.split('T')[0] <= end; }); const headers = ['STT', 'NGÀY CỌC', 'TÊN KH', 'TVBH', 'LOẠI XE', 'PHIÊN BẢN', 'NGOẠI THẤT TV', 'NỘI THẤT TV', 'GHI CHÚ']; const keys = ['stt', 'ngày_tt1', 'tên_kh', 'tvbh', 'loại_xe', 'phiên_bản', 'ngoại_thất_tv', 'nội_thất_tv', 'ghi_chú']; renderDataTable(document.getElementById('ky-content'), `Danh sách ký hợp đồng`, data, headers, keys, 'ky'); }
        function renderXuatTab() { const { start, end } = getDateRange(); const data = filteredData.filter(hd => hd.ngày_xhđ && hd.ngày_xhđ.split('T')[0] >= start && hd.ngày_xhđ.split('T')[0] <= end).map(hd => ({ ...hd, công_nợ: (parseFloat(hd.giá_chốt) || 0) - ((parseFloat(hd.tt1) || 0) + (parseFloat(hd.tt2) || 0) + (parseFloat(hd.tt3) || 0) + (parseFloat(hd.giải_ngân) || 0))})); const headers = ['STT', 'NGÀY XHĐ', 'TÊN KH', 'TVBH', 'LOẠI XE', 'PHIÊN BẢN', 'NGOẠI THẤT TV', 'NỘI THẤT TV', 'CÔNG NỢ', 'GHI CHÚ']; const keys = ['stt', 'ngày_xhđ', 'tên_kh', 'tvbh', 'loại_xe', 'phiên_bản', 'ngoại_thất_tv', 'nội_thất_tv', 'công_nợ', 'ghi_chú']; renderDataTable(document.getElementById('xuat-content'), `Danh sách xuất HĐ`, data, headers, keys, 'xuat'); }
        function renderCongNoCocTab() { const { start, end } = getDateRange(); const data = filteredData.map(hd => ({ ...hd, công_nợ: (parseFloat(hd.giá_chốt) || 0) - ((parseFloat(hd.tt1) || 0) + (parseFloat(hd.tt2) || 0) + (parseFloat(hd.tt3) || 0) + (parseFloat(hd.giải_ngân) || 0))})).filter(hd => { const ngayCoCoc = hd.ngày_có_coc; return ngayCoCoc && ngayCoCoc.split('T')[0] >= start && ngayCoCoc.split('T')[0] <= end && hd.công_nợ !== 0; }); const headers = ['STT', 'TÊN KH', 'TVBH', 'GIÁ CHỐT', 'CÔNG NỢ', 'GHI CHÚ']; const keys = ['stt', 'tên_kh', 'tvbh', 'giá_chốt', 'công_nợ', 'ghi_chú']; renderDataTable(document.getElementById('congno-content'), `Danh sách công nợ COC`, data, headers, keys, 'congno'); }
        function renderCocTab() { const { start, end } = getDateRange(); const today = new Date(); const data = filteredData.filter(hd => hd.ngày_đề_nghị_coc && !hd.ngày_có_coc).map(hd => { const deNghiDate = new Date(hd.ngày_đề_nghị_coc); if (isNaN(deNghiDate.getTime())) return { ...hd, tới_hôm_nay: '' }; return { ...hd, tới_hôm_nay: Math.floor((today - deNghiDate) / 86400000) }; }); const headers = ['STT', 'NGÀY ĐỀ NGHỊ', 'TỚI HÔM NAY', 'TÊN KH', 'TVBH', 'LOẠI XE', 'GHI CHÚ']; const keys = ['stt', 'ngày_đề_nghị_coc', 'tới_hôm_nay', 'tên_kh', 'tvbh', 'loại_xe', 'ghi_chú']; renderDataTable(document.getElementById('coc-content'), `Theo dõi COC`, data, headers, keys, 'coc'); }
        function renderDaGiaoTab() { const { start, end } = getDateRange(); const data = filteredData.filter(hd => hd.ngày_giao_xe && hd.ngày_giao_xe.split('T')[0] >= start && hd.ngày_giao_xe.split('T')[0] <= end); const headers = ['STT', 'NGÀY GIAO XE', 'TÊN KH', 'TVBH', 'LOẠI XE', 'SỐ KHUNG', 'GHI CHÚ']; const keys = ['stt', 'ngày_giao_xe', 'tên_kh', 'tvbh', 'loại_xe', 'số_khung', 'ghi_chú']; renderDataTable(document.getElementById('dagiao-content'), `Danh sách đã giao xe`, data, headers, keys, 'dagiao'); }
        function renderHoanCocTab() { const { start, end } = getDateRange(); const data = filteredData.filter(hd => hd.ngày_hoàn_cọc && hd.ngày_hoàn_cọc.split('T')[0] >= start && hd.ngày_hoàn_cọc.split('T')[0] <= end); const headers = ['STT', 'TÊN KH', 'TVBH', 'PKD', 'LOẠI XE', 'NGÀY HOÀN CỌC', 'SỐ TIỀN CỌC', 'GHI CHÚ']; const keys = ['stt', 'tên_kh', 'tvbh', 'team', 'loại_xe', 'ngày_hoàn_cọc', 'tt1', 'ghi_chú']; renderDataTable(document.getElementById('hoancoc-content'), `Danh sách hoàn cọc`, data, headers, keys, 'hoancoc'); }

        function renderDataTable(container, title, data, headers, keys, tabKey) {
             if (!container) return;
             if (data.length === 0) { container.innerHTML = `<div class="bg-white rounded-lg shadow-md"><h3 class="text-lg font-semibold p-4 border-b">${title} (0)</h3><div class="text-center p-8">Không có dữ liệu.</div></div>`; return; }
            if (!sortStates[tabKey]) sortStates[tabKey] = { key: keys[0], direction: 'asc' };
            const { key: sortKey, direction: sortDir } = sortStates[tabKey];
            
            data.sort((a, b) => {
                let valA = a[sortKey]; let valB = b[sortKey];
                if (sortKey === 'stt') return 0;
                if (typeof valA === 'string' && valA.includes('/')) { const dateA = valA.split('/').reverse().join('-'); const dateB = valB.split('/').reverse().join('-'); return sortDir === 'asc' ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA); }
                if (typeof valA === 'number' && typeof valB === 'number') { return sortDir === 'asc' ? valA - valB : valB - valA; }
                const compare = String(valA || '').localeCompare(String(valB || ''), 'vi', { numeric: true });
                return sortDir === 'asc' ? compare : -compare;
            });
            
            const getSortClass = (k) => (sortKey === k ? `sorted-${sortDir}` : '');
            let tableHtml = `<div class="bg-white rounded-lg shadow-md"><h3 class="text-lg font-semibold p-4 border-b">${title} (${data.length})</h3><div class="overflow-x-auto table-container"><table class="w-full text-sm data-table">`;
            tableHtml += `<thead class="bg-gray-50 text-left"><tr>${headers.map((h, i) => {
                let headerClass = `p-3 sortable ${getSortClass(keys[i])}`;
                if (keys[i] === 'ghi_chú') {
                    headerClass += ' ghi-chu-column';
                } else {
                    headerClass += ' fit-content-column';
                }
                return `<th class="${headerClass}" data-sort-key="${keys[i]}" data-table-type="${tabKey}">${h}</th>`;
            }).join('')}</tr></thead>`;
            
            tableHtml += `<tbody>${data.map((row, index) => { 
                const cells = keys.map(key => {
                    let cellClass = 'p-3';
                    let titleAttr = '';
                    let cellValue = row[key] || '';
                    let displayValue = cellValue;

                    if (key === 'ghi_chú') {
                        cellClass += ' ghi-chu-column';
                        displayValue = cellValue.split('--------------------')[0].trim();
                        // Gán toàn bộ nội dung ghi chú cho thuộc tính title để xem khi hover
                        titleAttr = `title="${cellValue.replace(/"/g, '&quot;')}"`;
                    } else {
                        cellClass += ' fit-content-column';
                    }

                    if (key === 'stt') { displayValue = index + 1; } 
                    else if (key.includes('ngày')) { displayValue = formatDate(cellValue); } 
                    else if (['tt1', 'giá_chốt', 'công_nợ', 'team'].includes(key)) { displayValue = formatCurrency(cellValue) || cellValue; }
                     
                    return `<td class="${cellClass}" ${titleAttr}>${displayValue}</td>`; 
                }).join(''); 
                return `<tr data-row-index="${row.rowIndex}" class="border-b clickable-row">${cells}</tr>`; 
            }).join('')}</tbody>`;

            tableHtml += `</table></div></div>`;
            container.innerHTML = tableHtml;
        }
    </script>
</body>
</html>