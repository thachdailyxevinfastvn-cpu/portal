<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yêu Cầu Ghép Xe - VinFast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fc; }
        .nav-link-active { background-color: #eef2ff; color: #1d4ed8; font-weight: 600; }
        .form-input, .form-select { width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: all 0.2s ease-in-out; background-color: white; font-size: 0.875rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        .btn-primary { background-color: #1d4ed8; color: white; padding: 10px 20px; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary:hover { background-color: #2563eb; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255, 255, 255, 0.75); z-index: 9999; }
        .toast { display: none; position: fixed; bottom: 20px; right: 20px; padding: 16px; border-radius: 8px; color: white; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.success { background-color: #16a34a; }
        .toast.error { background-color: #dc2626; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col min-h-screen">
        <!-- Header & Navigation (ĐÃ CẬP NHẬT) -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <a href="homepage.html" class="text-2xl font-bold text-blue-700">Portal VF</a>
                <div class="hidden md:flex items-center space-x-2">
                    <a href="homepage.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Trang chủ</a>
                    <a href="khoxe.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Kho xe</a>
                    <a href="Yeucaughepxe.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg nav-link-active">Yêu cầu ghép xe</a>
                    <a href="Chinhsach.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Chính sách</a>
                    <a href="nganhang.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Ngân hàng</a>
                    <a href="KPI.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">KPI</a>
                    <a href="Taovanban.html" class="px-4 py-2 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Tạo văn bản</a>
                </div>
                <div class="flex items-center">
                    <div id="user-profile" class="flex items-center space-x-3">
                         <span id="user-fullname" class="text-gray-800 font-semibold hidden md:block"></span>
                         <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500">
                    </div>
                    <button id="logout-btn" class="ml-4 text-gray-500 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                    <button id="mobile-menu-button" class="md:hidden ml-4 text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
            <div id="mobile-menu" class="md:hidden hidden bg-white border-t">
                <a href="homepage.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Trang chủ</a>
                <a href="khoxe.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Kho xe</a>
                <a href="Yeucaughepxe.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 nav-link-active">Yêu cầu ghép xe</a>
                <a href="Chinhsach.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Chính sách</a>
                <a href="nganhang.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ngân hàng</a>
                <a href="KPI.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">KPI</a>
                <a href="Taovanban.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tạo văn bản</a>
            </div>
        </header>

        <main class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-12 gap-6 items-start">
                <div class="col-span-12 lg:col-span-4 bg-white p-6 rounded-lg shadow-sm border border-gray-200 lg:sticky top-24">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">Tạo Yêu Cầu Mới</h2>
                    <form id="pairing-request-form" class="space-y-2">
                         <div><label for="tvbh" class="text-xs font-medium text-gray-600">Tư Vấn Bán Hàng (TVBH)</label><input type="text" id="tvbh" name="tvbh" class="form-input mt-1" readonly></div>
                        <div><label for="ten_khach_hang" class="text-xs font-medium text-gray-600">Tên Khách Hàng</label><input type="text" id="ten_khach_hang" name="ten_khach_hang" required class="form-input mt-1"></div>
                        <div><label for="loai_xe" class="text-xs font-medium text-gray-600">Loại Xe</label><select id="loai_xe" name="loai_xe" required class="form-select mt-1"><option value="" disabled selected>Đang tải...</option></select></div>
                        <div><label for="phien_ban" class="text-xs font-medium text-gray-600">Phiên bản</label><input type="text" id="phien_ban" name="phien_ban" required class="form-input mt-1" placeholder="VD: Plus, Eco..."></div>
                        <div><label for="ngoai_that" class="text-xs font-medium text-gray-600">Màu xe</label><input type="text" id="ngoai_that" name="ngoai_that" required class="form-input mt-1" placeholder="VD: Trắng, Đen..."></div>
                        <div><label for="noi_that" class="text-xs font-medium text-gray-600">Màu nội thất</label><input type="text" id="noi_that" name="noi_that" required class="form-input mt-1" placeholder="VD: Black, Beige..."></div>
                        <div><label for="da_coc" class="text-xs font-medium text-gray-600">Đã cọc (VNĐ)</label><input type="text" id="da_coc" name="da_coc" required class="form-input mt-1" placeholder="Chỉ nhập số"></div>
                        <div><label for="ngay_coc" class="text-xs font-medium text-gray-600">Ngày cọc</label><input type="date" id="ngay_coc" name="ngay_coc" required class="form-input mt-1"></div>
                        <button type="submit" class="btn-primary w-full !mt-4"><i class="fas fa-paper-plane mr-2"></i>Gửi Yêu Cầu</button>
                    </form>
                </div>
                <div class="col-span-12 lg:col-span-8 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">Hàng Chờ Ghép Xe</h2>
                    <div class="overflow-x-auto"><table class="w-full text-sm"><thead id="waiting-list-header" class="bg-gray-50"></thead><tbody id="waiting-list-body"></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <div id="loading-overlay" class="loading-overlay items-center justify-center"><i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i></div>
    <div id="toast" class="toast"></div>
    
    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             if (typeof KHO_XE_APPS_SCRIPT_URL === 'undefined' || !KHO_XE_APPS_SCRIPT_URL) {
                alert("Lỗi cấu hình: Vui lòng kiểm tra biến KHO_XE_APPS_SCRIPT_URL trong file config.js.");
                return;
            }
            const userDataString = sessionStorage.getItem('loggedInUser');
            if (userDataString) {
                const userData = JSON.parse(userDataString);
                document.getElementById('user-fullname').textContent = userData.fullName;
                document.getElementById('user-avatar').src = userData.imageUrl || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${userData.fullName.charAt(0)}`;
                document.getElementById('tvbh').value = userData.fullName;
            } else {
                document.getElementById('tvbh').value = "Chưa đăng nhập";
            }
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            fetchCarModels();
            fetchWaitingList();
            
            document.getElementById('pairing-request-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('da_coc').addEventListener('input', formatCurrencyInput);
        });

        async function fetchCarModels() {
            const select = document.getElementById('loai_xe');
            try {
                const res = await fetch(`${KHO_XE_APPS_SCRIPT_URL}?action=getCarModels`);
                if (!res.ok) throw new Error(`Lỗi mạng: ${res.statusText}`);
                const result = await res.json();
                if (result.status === "SUCCESS") {
                    select.innerHTML = '<option value="" disabled selected>-- Chọn loại xe --</option>';
                    result.data.forEach(model => {
                        select.innerHTML += `<option value="${model}">${model}</option>`;
                    });
                } else throw new Error(result.message);
            } catch (err) {
                select.innerHTML = '<option value="" disabled selected>Lỗi tải dữ liệu</option>';
                console.error("Lỗi fetchCarModels:", err);
            }
        }

        async function fetchWaitingList() {
            const tbody = document.getElementById('waiting-list-body');
            tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Đang tải...</td></tr>`;
            try {
                const res = await fetch(`${KHO_XE_APPS_SCRIPT_URL}?action=getWaitingList`);
                if (!res.ok) throw new Error(`Lỗi mạng: ${res.statusText}`);
                const result = await res.json();
                if (result.status === 'SUCCESS') {
                    renderWaitingList(result.data);
                } else throw new Error(result.message);
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">Lỗi: ${err.message}</td></tr>`;
                 console.error("Lỗi fetchWaitingList:", err);
            }
        }

        function renderWaitingList(data) {
            const thead = document.getElementById('waiting-list-header');
            const tbody = document.getElementById('waiting-list-body');

            thead.innerHTML = `<tr>
                <th class="p-3 text-left font-semibold text-gray-600">NGÀY YÊU CẦU</th>
                <th class="p-3 text-left font-semibold text-gray-600">TVBH</th>
                <th class="p-3 text-left font-semibold text-gray-600">TÊN KH</th>
                <th class="p-3 text-left font-semibold text-gray-600">YÊU CẦU XE</th>
                <th class="p-3 text-right font-semibold text-gray-600">ĐÃ CỌC (VNĐ)</th>
                <th class="p-3 text-left font-semibold text-gray-600">NGÀY CỌC</th>
            </tr>`;

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Chưa có yêu cầu nào.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 whitespace-nowrap">${row['NGÀY YÊU CẦU'] || ''}</td>
                    <td class="p-3">${row['TVBH'] || ''}</td>
                    <td class="p-3 font-medium">${row['TÊN KH'] || ''}</td>
                    <td class="p-3">
                        <div class="font-semibold">${row['LOẠI XE'] || ''} - ${row['PHIÊN BẢN TV'] || ''}</div>
                        <div class="text-xs text-gray-500">${row['NGOẠI THẤT TV'] || ''} / ${row['NỘI THẤT TV'] || ''}</div>
                    </td>
                    <td class="p-3 text-right">${Number(row['TT 1'] || 0).toLocaleString('vi-VN')}</td>
                    <td class="p-3 whitespace-nowrap">${row['NGÀY TT 1'] || ''}</td>
                </tr>
            `).join('');
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            showLoading(true);
            const form = event.target;
            const formData = new FormData(form);
            
            const dataObject = {};
            formData.forEach((value, key) => {
                dataObject[key] = value;
            });

            try {
                const res = await fetch(KHO_XE_APPS_SCRIPT_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify(dataObject) 
                });
                
                if (!res.ok) throw new Error(`Lỗi mạng: ${res.statusText}`);
                const result = await res.json();
                if (result.status !== 'SUCCESS') throw new Error(result.message);
                
                showToast(result.message, 'success');
                form.reset();
                const userDataString = sessionStorage.getItem('loggedInUser');
                if(userDataString) {
                     document.getElementById('tvbh').value = JSON.parse(userDataString).fullName;
                }
                await fetchWaitingList(); 
            } catch (err) {
                showToast(`Lỗi gửi yêu cầu: ${err.message}`, 'error');
                console.error("Lỗi handleFormSubmit:", err);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading) { document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none'; }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
        function formatCurrencyInput(event) {
            let value = event.target.value.replace(/[^0-9]/g, '');
            event.target.value = value ? Number(value).toLocaleString('vi-VN') : '';
        }
    </script>
</body>
</html>
